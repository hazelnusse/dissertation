\chapter{Mathematical model of bicycle motion} \label{chapter2}

\section{Introduction}
The bicycle model we use assumes the bicycle is composed of four rigid bodies:
two wheels, a frame, and a fork. These rigid bodies are assumed to be connected
by three frictionless revolute joints: one between the rear wheel and frame,
one between the front wheel and fork, and one between the bicycle frame and the
fork. The rigid wheels are modelled as torii which make point contact with the
ground plane. The frame and fork are each assumed to to be inertially
symmetric about in their respective $XZ$ planes. The revolute joint connecting
the frame and fork is assumed to be parallel to the $Z$ axis of the
each respective body. It is assumed that each wheel mass center lies in the
$XZ$ symmetry plane of the body to which it is connected, and that each wheel
revolute joint axis is parallel to the $Y$ axis of each respective body.

\section{Bicycle parameters}
The physical parameters used to describe the four rigid bodies, their interface
with each other and the ground plane is of practical concern for several
reasons. The choice of parameters determines how many quantities must be
measured or calculated when characterizing a real bicycle; some parameters are
more difficult to measure than others. The choice of parameters has a direct
effect on the complexity of the equations of
motion~\cite{Wittenburg2008,Mitiguy2001}, and by extension, the computational
cost associated with simulating or performing stability analysis of the
equations. Most importantly, the choice of parameters can greatly affect the
ease of understanding how changing a single parameter affects the dynamics.
Finally, having a common, agreed upon set of parameters which permit direct
comparisons is very valuable in communicating results to others -- if
everybody uses different parameters to describe the same model, comparisons
become difficult and error prone. We refer to the parameters used
in~\cite{Meijaard2007} as the ``Meijaard parameters'' (this is not the first
use of this parameter set, but it is the most clearly presented and widely
distributed work describing the choice). The Meijaard parameters have been
adopted as the \textit{de facto} by many authors~\cite{Sharp2008}. They can be
measured reasonably simply~\cite{Moore2010b}, and many of the parameters are
familiar to those outside academic circles (i.e., the bicycle industry, and
everyday cyclists). Examples of commonly recognizable parameters available at
your local bike shop include wheelbase $w$, trail $c$, and steer axis tilt
$\lambda$. For these reasons, this choice of parameters is indispensable.

There are strong reasons to prefer other choices of parameters. The Meijaard
parameters are ideally suited to direct derivation of linearized equations of
motion, about the reference configuration (lean and steer equal to zero). The
reason for this is that the Meijaard parameters are defined with respect to the
bicycle \textit{reference configuration} and with respect to a set of body
fixed coordinates that are aligned with the inertial frame \textit{only in this
configuration}. Deriving nonlinear equations of motion with this parameter set
is cumbersome and requires a number of intermediate geometric quantities to be
introduced. Perhaps the most serious disadvantage of the Meijaard parameter set
is the coupling between the parameters. Consider, for example, a parameter
study investigating the effect of front wheel radius on stability.  Using the
Meijaard parameters, a naive approach might be to choose a set of parameters
and compare the eigenvalues for that set with the eigenvalues when only the
wheel front wheel radius is changed. Unfortunately, this does not represent the
act of taking a real bicycle (with some set of parameters) and simply changing
the front wheel to one with identical mass and inertia but different radius.
Changing the front wheel radius of a real bicycle changes the steer axis tilt,
wheelbase, trail, center of mass locations relative to the rear wheel contact,
and, by virtue of the inertia scalars being defined relative to an inertial
frame, six of the inertia scalars. Thus, if the goal of an analyst or designer
is to understand the difference between how front wheel radius affects a
bicycle stability (a reasonable goal), and that person uses the Meijaard
parameter set to describe the bicycle, no fewer than \textit{thirteen}
additional parameters must be adjusted: the wheelbase $w$, trail $c$, steer
axis tilt $\lambda$, the central inertia scalars $I_{\text{B}xx}$,
$I_{\text{B}zz}$, $I_{\text{B}xz}$, $I_{\text{H}xx}$, $I_{\text{H}zz}$,
$I_{\text{H}xz}$, and the scalars describing the center of mass locations of
the bicycle frame and the fork $x_\text{B}$, $z_\text{B}$, $x_\text{H}$, and
$z_\text{H}$. This coupling of parameters is the result of defining the
parameters with respect to the reference configuration. If the naive approach
is used anyway, and all other parameters are left unchanged as
in~\cite{Moore2008,Tak2010}, it must be realized that when comparing results
which have only one of these coupled parameters changed (e.g., front wheel
radius), one is actually comparing bicycles with different frame and fork
geometry, center of mass location, and mass distribution since these must be
changed (on a real bicycle) in order to keep the Meijaard parameters constant.
Stated simply, one is not comparing effect of only front wheel radius, but the
effect of changing the front wheel radius and thirteen other parameters. The
practical utility of such a comparison is dubious at best. While this issue
\textit{can} be addressed by carefully changing the thirteen coupled
parameters, to our knowledge, no parameter study to date has done this. This is
a rarely stated, but critical, downside of the Meijaard parameters.

The easiest way to remedy the issue of parameter coupling is to choose physical
parameters which can be defined independent of configuration. This is standard
practice in robotics: robot link lengths are defined relative to the previous
link in the chain, and mass and inertia properties of each link are defined
with respect to a link-fixed coordinate system which is independent of overall
robot configuration. The thirteen Meijaard parameters which are defined
relative to the reference configuration can be arranged into three groups and
addressed separately. First, the wheelbase $w$, trail $c$, and steer axis tilt
$\lambda$ can be replaced with three distances which are independent of
configuration, as in~\cite{Franke1990}. Two of these measure the perpendicular
distance between the wheel centers and the steer axis while a third measures
the distance parallel to the steer axis between the first two lines. Second,
the bicycle frame and fork center of mass locations relative to the rear wheel
ground contact ($x_\text{B}, z_\text{B}, x_\text{H}, z_\text{H}$
in~\cite{Meijaard2007}) can be replaced with parameters which are defined
relative to the rear and front wheel centers, respectively. Finally, the
central inertia scalars of the bicycle frame and fork ($I_{\text{B}xx},
I_{\text{B}zz}, I_{\text{B}xz}, I_{\text{H}xx}, I_{\text{H}zz}, I_{\text{H}xz}$
in~\cite{Meijaard2007}) can be replaced with inertia scalars defined relative
to body-fixed coordinate systems which are aligned with a features fixed in the
body (such as the steer and wheel axes).

This section carefully describes the physical parameters used to model the
bicycle. These parameters address the issues raised in the previous two
paragraphs and also reduce the number of parameters needed to describe the same
four rigid bodies. This reduction is possible because the inertial properties
of rear frame and rear wheel are independent of the orientation of the rear
wheel relative to the rear frame (and similarly for the front fork and front
wheel). This parameterization of the physical properties of the bicycle is
collectively referred to as the gyrostat parameters. Finally, we present the
conversion from the Meijaard parameters to the gyrostat parameters.

\subsection{Gyrostat parameters} \label{model:gyrostat_parameters}
A gyrostat is a mechanical system of one or more bodies which has the rigid
body property that its inertia scalars are time independent
constants~\cite{Wittenburg2008}. The most common example of such a system is a
motor with a rotor which is inertially symmetric about the spin axis. As the
rotor rotates relative to the frame of the motor, neither the location of the
mass center nor the combined inertia of the system changes. This type of
gyrostat is referred to as a cylindrical gyrostat~\cite{Mitiguy2001}. The two
body cylindrical gyrostat is typically described as being composed of a carrier
and a rotor. A bicycle wheel and frame or fork is exactly such a gyrostat.

To aid the discussion which follows, we present the relationship between the
parameters which fully describe a cylindrical gyrostat and the parameters which
fully describe the two composing bodies. First consider a carrier $A$ with a
set of mutually perpendicular axes $X$, $Y$, $Z$ intersecting at the mass
center $A^*$ of $A$. $A$ has mass $m_A$, and let $\uv{a}{x}, \uv{a}{y},
\uv{a}{z}$ be unit vectors parallel to $X$, $Y$, $Z$, respectively, and express
the inertia dyadic of $A$ for $A^*$ as $\bs{I}^{A/A^*} =
I_{Axx}\uv{a}{x}\uv{a}{x} + I_{Ayy}\uv{a}{y}\uv{a}{y} +
I_{Azz}\uv{a}{z}\uv{a}{z} + I_{Axz}(\uv{a}{x}\uv{a}{z} + \uv{a}{z}\uv{a}{x})$.
$A$ is inertially symmetric about the $XZ$ plane. Attached to $A$ with a
revolute joint is rotor $B$ with mass $m_B$. Fixed to $B$ is a set of
mutually perpendicular axes $X'$, $Y'$, $Z'$, intersecting at the mass center
$B^*$ of $B$. Let the revolute joint axis be $Y'\parallel Y$, assume that $B^*$
lies in the $XY$ plane, and express the inertia dyadic of $B$ for $B^*$ as
$\bs{I}^{B/B^*} = I\uv{a}{x}\uv{a}{x} + J\uv{a}{y}\uv{a}{y} +
I\uv{a}{z}\uv{a}{z}$ (i.e., $B$ is inertially symmetric about the $Y'$ axis).
Let $\bs{r}^{B^*A^*} = a \uv{a}{x} + b \uv{a}{z}$ be the position vector
from the mass center of rotor $B$ to the mass center of carrier $A$.  Let $G^*$
denote the center of mass of $A$ and $B$ and let us refer to the cylindrical
gyrostat simply as $G$. The cylindrical gyrostat has mass
\begin{align}
  m_G &\triangleq m_A + m_B
\end{align}
and the position vector from $B^*$ to $G^*$ is
\begin{align}
  \bs{r}^{B^*G^*} &= \frac{m_A}{m_A + m_B}\left(a \uv{a}{x} + b \uv{a}{z}\right)
\end{align}
The inertia dyadic of $G$ for $G^*$ is
\begin{align}
  \bs{I}^{G/G^*} &= \bs{I}^{A/G^*} + \bs{I}^{B/G^*} \notag \\
                 &= \bs{I}^{A/A^*} + \bs{I}^{A^*/G^*} + \bs{I}^{B/B^*} +
                 \bs{I}^{B^*/G^*} \notag \\
%
                 &= \underbrace{\left(I + I_{Axx} + \frac{m_A m_B}{m_A + m_B}
               b^2 \right)}_{\triangleq I_{Gxx}}
                 \uv{a}{x}\uv{a}{x} \notag \\
%
                 &+ \underbrace{\left(J + I_{Ayy} + \frac{m_A m_B}{m_A + m_B} \left(a^2 +
               b^2\right)\right)}_{\triangleq I_{Gyy}} \uv{a}{y}\uv{a}{y} \notag \\
%
                 &+ \underbrace{\left(I + I_{Azz} + \frac{m_A m_B}{m_A + m_B}
               a^2 \right)}_{\triangleq I_{Gzz}}
                 \uv{a}{z}\uv{a}{z} \notag \\
%
                 &+ \underbrace{\left(I_{Axz} - \frac{m_A m_B}{m_A + m_B} a b
               \right)}_{\triangleq I_{Gxz}}
               \left(\uv{a}{x}\uv{a}{z} + \uv{a}{z}\uv{a}{x}\right)
\end{align}
where $\bs{I}^{A^*/G^*}$ denotes the inertia dyadic relative to $G^*$ of a
(fictitious) particle situated at $A^*$ and having a mass $m_A$ (similarly for
$\bs{I}^{B^*/G^*}$)~\cite{Kane1985}. Describing the dynamics of a gyrostat in
terms of $m_G, I_{Gxx}, I_{Gyy}, I_{Gzz}, I_{Gzz}, I_{Gxz}$, and $J$ (six
parameters) is substantially simpler than describing simpler than describing
the dynamics in terms of the parameters fundamental to each individual rigid
body $m_A, m_B, I, J, I_{Axx}, I_{Ayy}, I_{Azz}, I_{Azz}$, and $I_{Axz}$ (eight
parameters). This is partly due to the simple fact that there are two fewer
parameters to consider, but also due to significant simplifications that occur
when forming generalized inertia forces~\cite{Mitiguy2001}.

We assume the bicycle rear frame and rear wheel form a cylindrical gyrostat of
the same type as the example just presented, as do the fork and front wheel.
The bicycle may be considered to be composed of two such cylindrical gyrostats
whose carriers (the frame and fork) are connected by a revolute joint -- the
steer axis. It is natural to consider how many parameters are needed to
describe a bicycle using this formulation. In addition to the six inertial
parameters, each gyrostat requires five more parameters: two torus radii, two
distances defining the mass center location relative to the wheel axis and
finally the distance from the wheel axis to the steer axis along a
perpendicular to the steer axis. Thus eleven parameters are need to describe
each cylindrical gyrostat. One more parameter is necessary to define the
distance along the steer axis, between the line segments from each wheel center
to the steer axis. Thus, a total of twenty three parameters fully characterize
the model. These parameters are shown in \autoref{model:tab:parameters}. Some
of the parameters are illustrated in \autoref{model:fig:bicycle}.

\begin{table}[h]
  \centering
  \begin{tabular}{rl}
    \toprule
    Symbol & Description \\
    \midrule
    $I_{xx}, I_{yy}, I_{zz}, I_{xz}$ & gyrostat central inertia scalars \\
    $J$ & wheel spin moment of inertia \\
    $m$ & gyrostat mass \\
    $R, r$ & wheel major and minor radii \\
    $a, b$ & distances from wheel center to gyrostat mass center \\
    $c$ & distance from wheel center steer axis in $X$ direction \\
    $l_s$ & steer axis separation \\
    \bottomrule
  \end{tabular}
  \caption[Bicycle gyrostat parameters.]{Bicycle gyrostat parameters. To
    distinguish whether they are a property of the rear or the front gyrostat,
    the first 11 parameters are subscripted with $r$ or $f$. For example, $m_r$
    denotes the rear gyrostat mass, while $J_f$ denotes the front wheel spin
    moment of inertia. The steer axis separation $l_s$ is a property of how the
    two gyrostats are connected and hence is not subscripted in this fashion.}
  \label{model:tab:parameters}
\end{table}
\begin{figure}[htbp]
  \centering
  \begin{tikzpicture}[scale=4]
    %% Define constants
    \def\Rr{0.30cm}
    \def\Rf{0.32cm}
    \def\rr{0.02cm}
    \def\rf{0.01cm}
    \def\ar{0.514cm}
    \def\af{-0.15cm}
    \def\br{-0.25cm}
    \def\bf{-0.15cm}
    \def\cr{0.9cm}
    \def\cf{-0.25cm}
    \def\ls{0.5cm}
    \def\cmr{0.05cm}
    %% Locate important points
    \coordinate (RWO) at (0, 0);
    \coordinate (SAH) at ($(RWO) + (\cr, 0)$);
    \coordinate (SAF) at ($(SAH) - (0, \ls)$);
    \coordinate (FWO) at ($(SAF) - (\cf, 0)$);
    \coordinate (RO) at ($(RWO) + (\ar, -\br)$);
    \coordinate (FO) at ($(FWO) + (\af, -\bf)$);
    %% Draw important parts
    \node at ($(RWO) + (0,-.08cm)$) {$RW^*$};
    \node at ($(FWO) + (0.08cm,-.08cm)$) {$FW^*$};
    \node at ($(RO) + (0,.1cm)$) {$R^*$};
    \node at ($(FO) + (0,-.1cm)$) {$F^*$};
    \draw[draw=gray,dashed] (RWO) circle (\Rr);
    \draw[draw=gray,dashed] (FWO) circle (\Rf);
    \draw (RWO) circle (\Rr-\rr);
    \draw (FWO) circle (\Rf-\rf);
    \draw (RWO) circle (\Rr+\rr);
    \draw (FWO) circle (\Rf+\rf);
    \draw (270:\Rr+\rr+\rr+\rr+\rr) node {$R_r, r_r$};
    \draw (FWO) ++(90:\Rf+\rf+\rf+\rf+\rf+\rf+\rf) node {$R_f, r_f$};
    \draw[->,thick] (RWO) -- node[below] {$c_r$} (SAH);
    \draw[->,thick] (SAH) -- node[left] {$l_s$} (SAF);
    \draw[->,thick] (FWO) -- node[below] {$c_f$} (SAF);
    \filldraw[fill=gray,draw=gray] (RO) -- ++(\cmr, 0) arc (0:90:\cmr);
    \filldraw[fill=gray,draw=gray] (RO) -- ++(0, -\cmr) arc (270:180:\cmr);
    \draw(RO) circle (\cmr);
    \filldraw[fill=gray,draw=gray] (FO) -- ++(\cmr, 0) arc (0:90:\cmr);
    \filldraw[fill=gray,draw=gray] (FO) -- ++(0, -\cmr) arc (270:180:\cmr);
    \draw(FO) circle (\cmr);
    \draw[->] (RWO) -- node[left] {$b_r$} ++(0, -\br);
    \draw[->] ++($(RWO) + (0, -\br)$) -- node[auto] {$a_r$} ++(\ar, 0);
    \draw[->] (FWO) -- node[right] {$b_f$} ++(0, -\bf);
    \draw[->] ++($(FWO) + (0, -\bf)$) -- node[above] {$a_f$} ++(\af, 0);
    % Draw dots at center of wheels
    \filldraw (RWO) circle (.005cm);
    \filldraw (FWO) circle (.005cm);
    \filldraw (SAH) circle (.005cm);
    \filldraw (SAF) circle (.005cm);
    \filldraw (RO) circle (.005cm);
    \filldraw (FO) circle (.005cm);
    \coordinate (sa_label) at ($(SAH) + (0, .3cm)$);
    \coordinate (sah_label) at ($(SAH) + (.1cm, -.05cm)$);
    \draw[dashed,draw=gray] ($(SAF) + (0, -.3cm)$) -- (sa_label);
    \node[label=above:Steer axis] at (sa_label) {};
    \node[label=$SA_h$] at (sah_label) {};
  \end{tikzpicture}
  \caption[Bicycle geometric parameters.]{Bicycle geometric parameters. Not
    shown are the $X$ and $Z$ the gyrostat carriers which point to the right
    and down, respectively. As drawn, $b_r$, $a_f$, $b_f$, and $c_f$ are all
    negative; this is typical for traditional bicycles. Note that each
    parameter is defined without reference to the configuration of the bicycle.
    The head of the steer axis $SA_h$ is the point on top the steer axis and
    the foot of the steer axis $SA_f$ (not pictured) is the point on the bottom
    of the steer axis, both of which are fixed with respect to the gyrostat
    carriers $R$ and $F$.}
\label{model:fig:bicycle}
\end{figure}

Measuring the 23 (21 if the wheels are assumed to be knife edged) parameters
for a real bicycle is very similar to the procedure described
in~\cite{Moore2010b} except fewer measurements are needed. Instead of
determining the mass, mass center locations, and mass distribution of four
individual bodies, equivalent properties of only two cylindrical gyrostats need
to be measured. Practically speaking, this means only two masses need to be
measured (instead of four), the mass center locations and gyrostat inertia
measurements should be performed with the rear wheel and frame (front wheel and
fork) rigidly connected (i.e., wheel unable to spin), and the wheel moment of
inertia about an axis in the wheel plane needn't be measured (the wheel spin
inertia still does need to be measured, however). The time and energy savings
of the experimenter is fairly minor, however, the measurement of the fork
inertia can be problematic if the torsional pendulum stiffness is such that the
oscillations frequency are relatively high; by measuring the inertia of the
fork and wheel together, this is issue is mitigated to some degree. An
alternative method is to measure the exact parameters as described
in~\cite{Moore2010b}, and convert them to the gyrostat parameters as described
in \autoref{model:parameter_conversion}.

%The rear wheel is modelled as a rigid torus and is completely characterized by
%5 constant parameters: the major and minor radii, the mass, and two moments of
%inertia (one about the axis of symmetry, the other about any line in the wheel
%plane). The rear frame is modelled as a rigid body with unspecified geometry
%other than the spin axis of the wheel and steer axis which connects it to the
%fork. It is assumed that the two axes are perpendicular, that the frame is
%inertially symmetric about the plane perpendicular to the wheel spin axis, and
%that the steer axis lies in this symmetry plane. The bicycle frame is equipped
%with a dextral set of unit vectors: $\bs{r}_x, \bs{r}_y, \bs{r}_z=\bs{r}_x
%\times \bs{r}_y$ with $\bs{r}_y$ parallel the wheel axis and $\bs{r}_z$
%parallel to the steer axis. As described, the rear frame is completely
%characterized by 8 parameters: one distance between the wheel and steer axes as
%measured in the symmetry plane along a line perpendicular to the steer axis,
%two distances between the wheel spin axis and the mass center in the symmetry
%plane, the mass, and four central inertia scalars ($\bs{r}_x$ and $\bs{r}_z$
%are not assumed to be principal axes). If the rear wheel plane symmetry is
%constrained to lie in the bicycle symmetry plane, 13 parameters to completely
%describe these two bodies. Treated together, we can compute the combined mass,
%center of mass location (relative to the wheel axis), and the combined inertia
%about the center of mass. The combined mass and combined inertia represent 6
%unique scalar quantities as opposed to the 8 when the two bodies are considered
%separately. By describing the rear frame and rear wheel in terms of these
%combined parameters rather than the parameters intrinsic to each individual
%body, we use 2 fewer parameters. The same arguments apply to the  front fork
%and front wheel (replacing $\bs{r}_x, \bs{r}_y, \bs{r}_z$ with $\bs{f}_x,
%\bs{f}_y, \bs{f}_z$, respectively). With one final parameter describing the
%distance along the steer axis between the two bicycle frame and fork, we
%completely describe the bicycle with 23 parameters (11+11+1=23). See figure
%XXX.

\subsection{Parameter conversion}\label{model:parameter_conversion}
If the bicycle model in~\cite{Meijaard2007} is extended to use toroidal wheels
(as opposed to knife edged), and all Meijaard parameters remain otherwise
unchanged, a total of 27 parameters describe the bicycle model.  The two extra
parameters are the rear and front wheel minor radii, which we denote with
$t_\text{R}$ and $t_\text{F}$, respectively. The mapping from this 27
dimensional parameter space to the 23 dimensional gyrostat parameter space is
surjective -- distinct choices of Meijaard parameters can yield identical
gyrostat parameters (and hence identical dynamics). The practical implication
of this is that given a set of gyrostat parameters, it is not generally
possible to determine a unique set of the Meijaard parameters. This should not
be surprising given that it can be shown with dimensional analysis that the
minimal parameter space (assuming $t_\text{R}=t_\text{F}=0$) is only 9
dimensional~\cite{Sharp2008} (presumably it would be 11 dimensional if
$t_\text{R}$ and $t_\text{F}$ are included, though this has not been
verified).

In the equations that follow, the symbols used for the parameters presented
in~\cite{Meijaard2007} are on the right side of the equality, while the symbols
used to describe the gyrostat parameters are on the left of the equality. Some
parameters have very similar symbols but should not be confused as being the
same (i.e., $m_\text{f} \ne m_R$). Of the 23 gyrostat parameters, the following
6 have identical counterparts in the Meijaard parameters
\begin{align}
  J_r &= I_{\text{R}yy} \\
  R_r &= r_\text{R} \\
  r_r &= t_\text{R}\\
  J_f &= I_{\text{F}yy} \\
  R_f &= r_\text{F} \\
  r_f &= t_\text{F}
\end{align}
The rear and front gyrostat masses are trivially related
\begin{align}
  m_r &= m_\text{B} + m_\text{R} \\
  m_f &= m_\text{H} + m_\text{F}
\end{align}
With $s_\lambda=\sin\lambda$, $c_\lambda=\cos\lambda$, the mass center locations are related as
\begin{align}
a_r &= \frac{m_\text{B}}{m_\text{B} + m_\text{R}} \left(c_{\lambda} x_\text{B}
- s_{\lambda} \left(r_\text{R} + t_\text{R} + z_\text{B}\right)\right) \\
b_r &= \frac{m_\text{B}}{m_\text{B} + m_\text{R}} \left(c_{\lambda}
\left(r_\text{R} + t_\text{R} + z_\text{B}\right) + s_{\lambda} x_\text{B}\right) \\
a_f &= - \frac{m_\text{H}}{m_\text{F} + m_\text{H}} \left(c_{\lambda} \left(w -
x_\text{H}\right) + s_{\lambda} \left(r_\text{F} + t_\text{F} + z_\text{H}\right)\right) \\
b_f &= \frac{m_\text{H}}{m_\text{F} + m_\text{H}} \left(c_{\lambda}
\left(r_\text{F} + t_\text{F} + z_\text{H}\right) - s_{\lambda} \left(w -
x_\text{H}\right)\right)
\end{align}
The three parameters which describe the perpendicular distance of the wheel centers from the
steer axis, and the distance between these perpendicular lines are
\begin{align}
c_r &= c_{\lambda} \left(c + w\right) - s_{\lambda} \left(r_\text{R} +
t_{R}\right) \\
c_f &= c_{\lambda} c - s_{\lambda} \left(r_\text{F} + t_\text{F}\right) \\
l_s &= - c_{\lambda} \left(r_\text{F} - r_\text{R} + t_\text{F} - t_\text{R}\right) + s_{\lambda} w
\end{align}
The central inertia scalars of the two gyrostats in terms of the Meijaard
parameters are
\begin{align}
I_{rxx} &=
I_{\text{R}xx} +
c_\lambda^2 I_{\text{B}xx} - 2 s_\lambda c_\lambda I_{\text{B}xz} + s_\lambda^2
I_{\text{B}zz} \notag\\
& + \frac{m_\text{R} m_\text{B}}{\left(m_\text{R} +
m_\text{B}\right)}\left(s_\lambda x_\text{B} + c_\lambda \left(r_\text{R} +
t_\text{R} + z_\text{B}\right)\right)^2 \\
%
I_{ryy} &= I_{\text{R}yy} + I_{\text{B}yy} \notag\\
& + \frac{m_\text{R} m_\text{B}}{\left(m_\text{R} + m_\text{B}\right)}
\left(x_\text{B}^2 + \left(r_\text{R} + t_\text{R} + z_\text{B}\right)^2
\right) \\
%
I_{rzz} &= I_{\text{R}xx} +
s_\lambda^2 I_{\text{B}xx} + 2 s_\lambda c_\lambda I_{\text{B}xz} + c_\lambda^2
I_{\text{B}zz} \notag\\
& + \frac{m_\text{R} m_\text{B}}{\left(m_\text{R} + m_\text{B}\right)}
\left(c_{\lambda} x_\text{B} - s_\lambda \left(r_\text{R} + t_\text{R} +
z_\text{B}\right)\right)^{2}\\
%
I_{rxz} &= \left(c_\lambda^2 - s_\lambda^2\right) I_{\text{B}xz}
+ s_\lambda c_\lambda \left(I_{\text{B}xx} - I_{\text{B}zz}\right) \notag\\
& - \frac{m_\text{B} m_\text{R}}{\left(m_\text{B} + m_\text{R}\right)}
\left(c_\lambda x_\text{B} - s_\lambda \left(r_\text{R} + t_\text{R} +
z_\text{B}\right)\right) \left(s_{\lambda} x_\text{B} + c_\lambda \left(r_\text{R} + t_\text{R} +
z_\text{B}\right)\right) \\
%
I_{fxx} &= I_{\text{F}xx} +
c_\lambda^2 I_{\text{H}xx} - 2 s_\lambda c_\lambda I_{\text{H}xz} + s_\lambda^2
I_{\text{H}zz} \notag\\
& + \frac{m_\text{H} m_\text{F}}{\left(m_\text{F} + m_\text{H}\right)} \left(- s_{\lambda} \left(w -
x_\text{H}\right) + c_{\lambda}
\left(r_\text{F} + t_\text{F} + z_\text{H}\right)\right)^{2}\\
%
I_{fyy} &= I_{\text{F}yy} + I_{\text{H}yy} \notag \\
& + \frac{m_\text{F} m_\text{H}}{\left(m_\text{F} + m_\text{H}\right)}
\left(\left(w - x_\text{H}\right)^2 + \left(r_\text{F} + t_\text{F} +
z_\text{H}\right)^2\right) \\
%
I_{fzz} &= I_{\text{F}xx} +
s_\lambda^2 I_{\text{H}xx} + 2 s_\lambda c_\lambda I_{\text{H}xz} + c_\lambda^2
I_{\text{H}zz} \notag\\
& + \frac{m_\text{F} m_\text{H}}{\left(m_\text{F} + m_\text{H}\right)} \left(c_{\lambda}
\left(w - x_\text{H}\right) + s_{\lambda} \left(r_\text{F} + t_\text{F} +
z_\text{H}\right)\right)^{2}\\
%
I_{fxz} &= \left(c_\lambda^2 - s_\lambda^2\right) I_{\text{H}xz}
+ s_\lambda c_\lambda \left(I_{\text{H}xx} - I_{\text{H}zz}\right) \notag\\
& + \frac{m_\text{F} m_\text{H}}{\left(m_\text{F} + m_\text{H}\right)}
\left(c_\lambda \left(w - x_\text{H}\right) + s_\lambda \left(r_\text{F} +
t_\text{F} + z_\text{H}\right)\right) \left(- s_{\lambda} \left(w -
x_\text{H}\right) + c_\lambda \left(r_\text{F} + t_\text{F} +
z_\text{H}\right)\right)
\end{align}
The numerical values of the benchmark parameter set presented
in~\cite{Meijaard2007} convert to the gyrostat parameters shown in
\autoref{model:table:parameters}.

\begin{table}[htbp]
  \centering
  \begin{tabular}{rccl}
    \toprule
    & {Rear gyrostat} & {Front gyrostat} & {Units} \\
    \midrule
    $I_{xx}$ &   7.684799791449106 &    0.4335379755311007  & \si{\kg\m\squared} \\
    $I_{yy}$ &   11.99931034482759 &    0.5746857142857142  & \si{\kg\m\squared} \\
    $I_{zz}$ &   5.315110553378478 &    0.1481477387546135  & \si{\kg\m\squared} \\
    $I_{xz}$ &   4.262158094617231 &  0.005332503757935524  & \si{\kg\m\squared} \\
         $J$ &                0.12 &                  0.28  & \si{\kg\m\squared} \\
         $m$ &                  87 &                     7  & \si{\kg}     \\
         $R$ &                 0.3 &                  0.35  & \si{\m}      \\
         $r$ &                   0 &                     0  & \si{\m}\\
         $a$ &  0.4599058376856177 & -0.003411905099535333  & \si{\m}\\
         $b$ & -0.4669419422355365 &   -0.2114010400161699  & \si{\m}\\
         $c$ &  0.9534570696121847 &   -0.0320714267276193  & \si{\m}\\
         $l_s$ & \multicolumn{2}{c}{0.2676445084476887} &  \si{\m} \\
  \bottomrule
  \end{tabular}
  \caption[Benchmark bicycle parameters converted to gyrostat
    parameters.]{Benchmark bicycle parameters converted to gyrostat parameters.
    Parameters shown to 15 or more decimal places are not exact.}
  \label{model:table:parameters}
\end{table}

\section{Kinematics} \label{model:kinematics}

Were the four bodies of the bicycle model to be disconnected and free to move
in an arbitrary manner, the system would have 24 degrees of freedom (4 bodies,
6 degrees of freedom per body). Accounting for the 3 revolute joints (wheel
axes and steer axis) reduces the number of degrees of freedom from 24 to 9
(each revolute joint removes 5 degrees of freedom). Requiring the lowest point
of the rear wheel and front wheel to touch the horizontal ground plane removes
two further degrees of freedom, resulting in 7 configuration degrees of
freedom. A minimal choice of configuration variables is not practical (nor
generally possible for all configurations) due to the complexity of the
holonomic constraint (it is nonlinear and has multiple
roots)~\cite{Peterson2008a}.

The revolute joints and the requirement that the wheels make point contact with
the ground plane are configuration (holonomic) constraints. Without any further
restrictions regarding the wheel contact with the ground, the system has 7
velocity degrees of freedom as well. If simulation or stability analysis of
such a model is desired, a model for the forces at the wheel contact points is
needed. If it is instead assumed that the wheels roll without slip (said
another way, the wheel contact forces are whatever is necessary to prevent
slip), 4 more degrees of freedom are removed (2 from each no-slip assumption),
yielding a system with 3 velocity degrees of freedom. The no-slip assumptions
do not constrain the configuration in any way, so the accessible configuration
space remains 7 dimensional, but the dimension of the accessible velocity space
is reduced from 7 to 3 under the assumption of no-slip.  The remainder of this
chapter assumes that the wheels do not slip relative to the ground (and hence
the system has 3 velocity degrees of freedom).

A wise choice of generalized coordinates can result in a reduction of the
number of configuration constraints that need to be solved. A familiar example
is the pendulum: using $x$ and $y$ to locate the pendulum mass and deriving the
equations of motion in terms of $x$ and $y$ (and their derivatives) requires
enforcing the constraint $l - \sqrt{x^2 + y^2} = 0$. This choice is ill advised
and best avoided in favor of choosing a single generalized coordinate (i.e.,
the pendulum angle $\theta$) which implicitly satisfies the length constraint.
It is generally in the interest of the analyst to introduce the minimal
number of coordinates possible so that needless configuration constraint
equations are avoided.

Similarly, a wise choice of generalized speeds can reduce or eliminate the
number of velocity constraints that need to be solved. A familiar example of
this is the rolling disk: only three generalized speeds are needed to fully
describe the angular velocity of the disk \textit{and} the velocity of the disk
mass center, and therefore no velocity constraint equations need to be solved
explicitly to obtain the dynamic equations. If instead one introduces six
generalized speeds (e.g., three for the disk angular velocity and three for the
velocity of the mass center), three scalar constraint equations must be
satisfied and hence only three of the generalized speeds can be chosen
independently. Which to choose as independent in the case of the rolling disk
is fairly obvious, but for more complicated systems this is not generally the
case and care must be taken\cite{Reckdahl1996}. Just as in the case for
generalized coordinates, it is generally in the interest of the analyst to
introduce the minimal number of generalized speeds as possible so that needless
velocity constraint equations are avoided.

With this wisdom in mind, we describe the configuration and velocity of the
bicycle with 8 generalized coordinates and 6 speeds. This choice results in 1
configuration constraint and 3 velocity constraints. With the exception of
frame pitch the coordinates used are identical to the coordinates presented
in~\cite{Meijaard2007}.

Let $X_NY_NZ_N$ be a set of mutually perpendicular axes fixed in a Newtonian
frame $N$, intersecting at the inertial origin $N^*$, with the positive $Z$
axis pointing down into the ground plane and parallel to the local
gravitational field. Let $\uv{n}{x}, \uv{n}{y}, \uv{n}{z}$ be a set of dextral
unit vectors aligned with $X, Y, Z,$ respectively. Similarly let the rear
gyrostat carrier $R$ and the front gyrostat carrier $F$ be equipped with axes
$X_RY_RZ_R$ and $X_FY_FZ_F$, respectively, each intersecting at their
respective gyrostat mass centers $R^*$ and $F^*$. Let $Z_R \parallel Z_F$ also
be parallel to the steer axis $SA$. Further, let the wheel spin axis of each
carrier be parallel to $Y_R$ and $Y_F$, respectively. Let $\uv{r}{x},
\uv{r}{y}, \uv{r}{z}$ be a set of dextral unit vectors aligned with $X_R, Y_R,
Z_R$, respectively, and similarly let $\uv{f}{x}, \uv{f}{y}, \uv{f}{z}$ be a
set of dextral unit vectors aligned with $X_F, Y_F, Z_F$, respectively.

To orient $R$ relative to $N$, first align $X_RY_RZ_R$ with $X_NY_NZ_N$ then
apply a sequence of body fixed $ZXY$ rotations: yaw $\psi$, lean $\phi$, and
pitch $\theta$. The two intermediate frames in the sequence of rotations are
the instantaneous yaw frame $Y$ and the instantaneous lean frame $L$. To orient
$F$ relative to $R$, first align $X_FY_FZ_F$ with $X_RY_RZ_R$ (and note that
$Z_R \parallel SA \parallel Z_F$, then a apply a right handed rotation to $F$
about SA by steer angle $\delta$. Finally, to orient the wheels relative to
their respective carrier, apply simple right handed rotations of the wheel
relative to the carrier by angles $\theta_r$ and $\theta_f$, respectively.
These six rotations completely define the orientation of all frames relative to
each other. 

The position of the gyrostat mass centers relative to the wheel centers is
defined by the choice of parameters $a_r, b_r, a_f, b_f$ (see
\autoref{model:fig:bicycle}). The from the rear wheel center $RW^*$ to the rear
gyrostat mass center $R^*$ is $\bs{r}^{RW^*R^*} = a_r \uv{r}{x} + b_r
\uv{r}{z}$; similarly the position from the front wheel center $FW^*$ to the
front gyrostat mass center $F^*$ is $\bs{r}^{FW^*F^*} = a_f \uv{f}{x} + b_f
\uv{f}{z}$. The position from the rear wheel center to the front wheel center
is $\bs{r}^{RW^*FW^*} = c_r \uv{r}{x} + l_s \uv{r}{z} - c_f \uv{f}{x}$. We
introduce the final two generalized coordinates $x$ and $y$, to locate the rear
wheel ground contact $P$, The position from the inertial origin $N^*$ to the
rear wheel ground contact $P$ is $\bs{r}^{N^*RW^*} = x \uv{n}{x} + y
\uv{n}{y}$. The position from $P$ to the rear wheel center $RW^*$ is as
$\bs{r}^{PRW^*} = - r_r \uv{y}{z} - R_r \uv{l}{z}$ ($\uv{y}{z}$ is the downwards
vertical unit vector of the instantaneous yaw frame $Y$, and $\uv{l}{z}$ is the
result of rotating $\uv{y}{z}$ be lean angle $\phi$).  The remaining point is
the front wheel ground contact $Q$. To define the position from the front wheel
center $FW^*$ to $Q$ we introduce the unit vector
\begin{align}
  \uv{g}{z} &= \frac{\uv{y}{z} - (\uv{f}{y} \cdot \uv{y}{z})
  \uv{f}{y}}{|\uv{y}{z} - (\uv{f}{y} \cdot \uv{y}{z})
  \uv{f}{y}|}
\end{align}
which is the projection of the downwards vertical vector $\uv{y}{z}=\uv{n}{z}$
onto the front wheel plane ($\uv{f}{y}$ is normal to the front wheel plane).
The position from the front wheel center is now be simply written as
$\bs{r}^{FW^*Q} = R_f \uv{g}{z} + r_f \uv{y}{z}$. The eight generalized
coordinates used to fully orient the four bodies and locate each of the mass
centers summarized in \autoref{model:tab:coordinates}.

\begin{table}[htbp]
  \centering
  \begin{tabular}{ccc}
    \toprule
    Coordinate & Description & Units \\
    \midrule
    $\psi$ & Bicycle frame yaw angle & \si{\radian} \\
    $\phi$ & Bicycle frame lean angle & \si{\radian} \\
    $\theta$ & Bicycle frame pitch angle  & \si{\radian} \\
    $\delta$ & Steer angle & \si{\radian} \\
    $\theta_r$ & Rear wheel angle & \si{\radian} \\
    $\theta_f$ & Front wheel angle & \si{\radian} \\
    $x$ & Rear wheel contact $P$ $X_N$ measure number & \si{\m} \\
    $y$ & Rear wheel contact $P$ $Y_N$ measure number & \si{\m} \\
    \bottomrule
  \end{tabular}
  \caption[Bicycle generalized coordinates.]{Bicycle generalized coordinates.
    In the upright $\phi=0$ zero steer $\delta=0$ configuration, the pitch
    angle $\theta$ is equal to the steer axis tilt $\lambda$ of the benchmark
    parameter set. This is in contrast to the pitch $\theta_{\text{B}}$ defined
    in~\cite{Meijaard2007}, which is zero in the same configuration. The two
    pitch coordinates are related as $\theta = \theta_{\text{B}} + \lambda$;
    the other 7 coordinates are identical.}
  \label{model:tab:coordinates}
\end{table}

In order to maintain contact with the ground plane the following configuration
constraint must be satisfied
\begin{align}
  \bs{r}^{PQ} \cdot \uv{y}{z} &= 0
\end{align}
which is the mathematical statement that the lowest point of the front wheel
must lie in the ground plane. The dot product on the left hand side depends on
the three coordinates lean $\phi$, pitch $\theta$, steer $\delta$, and seven
geometric parameters (the wheel radii $R_r, r_r, R_f, r_f$, and the distances
$c_r, c_f$, and $l_s$). We introduce a vector $q\in\mathbb{R}^3$ for the three
coordinates and a vector $p\in\mathbb{R}^7$ for the parameters involved in this
constraint
\begin{align}
  q &\triangleq \left[\phi, \theta, \delta\right]\label{model:q_min}\\
  p &\triangleq \left[R_r, r_r, R_f, r_f, c_r, c_f, l_s\right]
  \label{model:constraint_parameters}
\end{align}
we can write the configuration constraint concisely as
\begin{align}
  f_c(q, p) &= 0
  \label{model:f_c}
\end{align}
where $f_c : \mathbb{R}^3 \times \mathbb{R}^7 \mapsto \mathbb{R}$.  The three
elements of $q$ cannot be varied independent and most often the pitch $\theta$
is selected to be a dependent coordinate.

The angular velocity of the four bodies and the velocity of the gyrostat mass
centers can be defined with only six generalized speeds. These six generalized
speeds are defined as follows
\begin{align}
  u_{1} &\triangleq \dot{\psi} \\
  u_{2} &\triangleq \dot{\phi} \\
  u_{3} &\triangleq \dot{\theta} \\
  u_{4} &\triangleq \dot{\delta} \\
  u_{5} &\triangleq \dot{\theta}_r \\
  u_{6} &\triangleq \dot{\theta}_f
\end{align}
The angular velocity of the four bodies relative to the $N$ is fully
established by the following relations
\begin{align}
  {}^{N}\bs{\omega}^{R} &= u_1 \uv{y}{z} + u_2 \uv{l}{x} + u_3\uv{r}{y} \\
  {}^{R}\bs{\omega}^{F} &= u_4 \uv{r}{z} = u_4 \uv{f}{z} \\
  {}^{R}\bs{\omega}^{RW} &= u_5 \uv{r}{y} \\
  {}^{F}\bs{\omega}^{FW} &= u_6 \uv{f}{y}
\end{align}
The velocity of the gyrostat mass centers $R^*$ and $F^*$, relative to $N$, are
obtained by assuming the wheel contacts $P$ and $Q$ do not slip relative to the
ground plane (i.e., ${}^{N}\bs{v}^{P} = {}^{N}\bs{v}^{Q} = \bs{0}$) and applying the two
point velocity theorem to form the velocity of the wheel centers as follows
\begin{align}
  {}^{N}\bs{v}^{RW^*} &= {}^{N}\bs{\omega}^{RW} \times \bs{r}^{PRW^*} \\
  {}^{N}\bs{v}^{R^*} &= {}^{N}\bs{v}^{RW^*} + {}^{N}\bs{\omega}^{R} \times \bs{r}^{RW^*R^*} \\
  {}^{N}\bs{v}^{FW^*} &= {}^{N}\bs{\omega}^{FW} \times \bs{r}^{QFW^*} \\
  {}^{N}\bs{v}^{F^*} &= {}^{N}\bs{v}^{FW^*} + {}^{N}\bs{\omega}^{F} \times \bs{r}^{FW^*F^*}
\end{align}
The velocity constraints are obtained by equating the velocity of a point on
the steer axis obtained in two separate, but equally valid ways. Because the
steer axis is fixed in both gyrostat carriers, the velocity of this point
obtained with the two approaches must be equal. The velocity of the head of the
steer axis $SA_h$ (see \autoref{model:fig:bicycle}) is obtained by working from
the rear contact $P$ through the rear wheel $RW$ and bicycle frame $R$
\begin{align}
  {}^{N}\bs{v}^{SA_h}_r &= {}^{N}\bs{v}^{RW^*} + {}^{N}\bs{\omega}^{R} \times \bs{r}^{RW^*SA_h}
\end{align}
while working from the front contact point $Q$ through the front wheel $FW$ and
fork $F$ gives
\begin{align}
  {}^{N}\bs{v}^{SA_h}_f &= {}^{N}\bs{v}^{FW^*} + {}^{N}\bs{\omega}^{F} \times \bs{r}^{FW^*SA_h}
\end{align}
where $_r$ and $_f$ denote which set of bodies were used to when obtaining the
velocity of $SA_h$. The velocity constraints in vector form are then
\begin{align}
  {}^{N}\bs{v}^{SA_h}_r - {}^{N}\bs{v}^{SA_h}_f &= \bs{0}
  \label{model:eq:f_v_vec}
\end{align}
Taking the dot product of \autoref{model:eq:f_v_vec} with any three
perpendicular vectors (i.e., $\uv{r}{x}, \uv{r}{y}, \uv{r}{z}$), yields three
scalar equations which are linear in the 6 generalized speeds $u_1 \dots u_6$.
These three scalar equations can be written in matrix form as
\begin{align}
  B(q, p) u &= 0
  \label{model:eq:f_v_matrix}
\end{align}
where $B\in\mathbb{R}^{3 \times 6}$, $u\in\mathbb{R}^{6 \times 1}$ and $p$ and
$q$ are defined in \autoref{model:q_min} and
\autoref{model:constraint_parameters}, respectively. By choosing three of the
six generalized speeds as independent, it is possible to solve
\autoref{model:eq:f_v_matrix} for the other three (dependent) speeds.
Typically, lean rate $\dot{\phi} = u_2$, steer rate $\dot{\delta} = u_4$, and
one of the wheel rates ($\dot{\theta}_r = u_5$ or $\dot{\theta}_f = u_6$) are
chosen to be the independent speeds.


\section{Dynamics}
A large portion of the complexity of the bicycle dynamic equations is caused by
the velocity constraints. However, careful book keeping of the kinematic
quantities using a symbolic computer algebra system such as SymPy~\cite{SymPy}
makes forming the dynamic equations much less tedious. The kinematics as
presented in \autoref{model:kinematics} were programmed into a Python script
which derives the dynamic equations of motion using Kane's
method~\cite{Kane1985}. The symbolic equations were exported to C++ files which
were then compiled into a software library~\cite{libbicycle} which provides
efficient and convenient functionality to compute eigenvalues, calculate ground
reaction forces, compute linearized system dynamics matrices, and perform
numerical simulation. This library was used to compute all the system dynamics
matrices used in the design of the control system presented in
\autoref{chapter4}.


