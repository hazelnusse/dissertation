\chapter{Linearization of equations of motion of constrained multibody systems}
\label{chapter3}
\section{Introduction}
\label{sec:intro}

Many common dynamic mechanical systems have configuration or velocity
constraints.  Analyses of such systems often require linearized forms of the
motion equations.  To address this issue, we developed a procedure for
organizing the constraint and motion equations and their subsequent
linearization.  This procedure was specifically developed for equations of
motion generated by Kane's method, but is compatible with any method as long as
the following are true: only ordinary differential equations are required to
describe the system, and independent and dependent states remain in the final
equations (i.e. no DAE's, no substitution of variables).  Following a brief
review of Kane's method and the structure of the equations it generates, we
present the procedure to symbolically linearize the nonlinear motion equations
of constrained multibody systems, and illustrate it with the familiar example
of the rolling disk.

Design of linear state feedback controllers and first order stability analysis
of equilibria are two of the most common uses of multibody system dynamics
models. Both of these uses require linearized equations of motion. For
unconstrained systems, obtaining the linearized equations of motion is as
simple as arranging the equations of motion in first order form ($\dot{x} =
f(x, t)$) and evaluating the Jacobian of the right hand side function, with
respect to the states, evaluated at the equilibria point of interest.  However,
when the system in questions has constraints, i.e., not all the states are
independent, this process is not as straightforward.

For a system system with constraints, Kane's dynamical
equations~\cite{Kane1985} are first order ODE's (in the generalized speeds)
which include both the independent and dependent states (assuming the
dependents states have not been algebraically eliminated). The kinematical and
dynamical differential equations can be solved for the time derivatives of the
generalized coordinates and generalized speeds, respectively. Taken together,
it is tempting to think that this system of first order differential equations
could be linearized in the same fashion as an unconstrained system.
Unfortunately, this is not the case.  Linearizing these equations in the same
manner as one would for an unconstrained system (by directly computing the
Jacobian) is incorrect and will yield incorrect linearized equations (and
subsequently incorrect eigenvalues, in the case of a stability analysis). We
illustrate this by means of a familiar example, the rolling disk, formulated
with a non-traditional set of coordinates and generalized speeds which are not
all independent. We provide a systematic method to correctly generate the
linear equations of motion for constrained systems which have been found using
Kane's method (or any other method which results in equations with the same
form). We apply this method to the rolling disk example to illustrate that it
yields eigenvalues that match previously published results.

We consider three types of constraints: configuration, velocity, and
acceleration. Configuration constraints limit the location or orientation of
parts of the system, relative to the external world or other parts of the
system. Velocity constraints limit the speeds at which the configuration can
change, either from configuration constraints (through time differentiation) or
independent application. Velocity constraints most often appear in systems
where there is rolling without slip or there are closed kinematic loops. In the
context of this chapter, acceleration constraints arise either from time
differentiated velocity constraints or similar kinematic considerations.

% TODO: Improve literature review.
Bottema appears to be the first author to have shown that special
considerations are needed for linearizing nonholonomic
systems~\cite{Bottema1949}. While other authors have examined linearization of
nonholonomic systems, we have found that most techniques are not directly
applicable to equations formed using Kane's method, and while we do not doubt
that they \textit{could} be applied correctly, the details of how to do so, as
far as the authors are aware, have not been explicitly presented. Kang et
al.~\cite{Kang2003} and Negrut and Ortiz~\cite{Negrut2006} have both explored
linearization, but these methods have been developed for equations of motion
found using Lagrange's method, which contain Lagrange multipliers (which are
not present in equations of motion generated from Kane's method). Further, both
of these papers lack a discussion of basic concepts such as how many quantities
are independent, and in the case of eigenvalue computation, how many
eigenvalues should be present. Minaker and Rieveley~\cite{Minaker2010} and
Schwab and Meijaard~\cite{Schwab2003} both have developed techniques for
generating equations of motion (and linear forms thereof) using Lagrange's
method; the work of Schwab and Meijaard can be applied symbolically while
Minaker and Reiveley's approach is numeric in nature. Neither discuss the
choice of generalized speeds as in Kane's method: both form the equations of
motion in terms of second time derivatives of the coordinates.  Further,
neither of these works address constraints which cannot be eliminated (i.e.,
nonlinear configuration constraints), nor do they address what approach should
be taken when a single choice of dependent states may not suffice. While Neuman
presents a symbolic (as opposed to numeric) formulation for linearization of
the Q-matrix formulation of the Lagrangian~\cite{Neuman1984}, his work makes no
mention of constrained systems and attempts to contact the author regarding the
software (algebraic robot modeler -- Arm) as well as internet searches for the
software have been fruitless.

The goal of this chapter is to definitively establish how the first time
derivative of all coordinates and speeds (independent and dependent)
depend, to first order, upon a selection of independent coordinates and
independent speeds, for an arbitrary point of linearization. We demonstrate how
a reduced portion of these linearized equations can be used to perform standard
stability analysis (i.e., for control system design or linear stability
analysis). The formalism presented here is generic enough to cover most
examples of time-varying constrained multibody systems with arbitrary external
inputs and arbitrary specified quantities.  The procedure was created for
systems whose equations of motion have been derived with Kane's method.
Although also applicable to dynamic system equations formulated using other
methods, it is restricted to systems which can be completely described by a set
of ODE's (i.e., DAE's needn't be solved).

We begin with a review of Kane's method for generating equations of motion is
reviewed first, in order to properly orient the reader to the format and some
of the qualities of the generated equations. Next, we apply Kane's method to
generate the equations of motion for the rolling disk, but we purposefully
introduce a dependent coordinate and three dependent speeds in the formulation.
The need for a different linearization technique is demonstrated with this
example. In response to this need, we present the newly developed linearization
procedure and its derivation. This new linearization procedure is applied to the
same rolling disk example to illustrate its validity and an example of its
application. Finally, we discuss other details and nuances of the procedure and
its use, as well as directions for future work.

\section{Kane's method, briefly}
\label{sec:kane_method}
To familiarize the reader with Kane's method, some concepts relating to its use
will be described.  The first is the use of generalized speeds in addition to
generalized coordinates.  The second concept is in how these generalized speeds
can be used to project permissible motions of the system, and how this removes
the need to consider non-contributing (internal constraint) forces.  Then, the
mathematical steps required to use Kane's method are shown and described.

When using Lagrange's method, generalized coordinates are used to describe the
configuration of a system while the time derivatives of the generalized
coordinates describe the velocities of a system.  Kane's method allows for the
velocities of a system to be written in terms of generalized speeds, which are
not required to be the time derivatives of coordinates (although such a
definition is permitted).

The benefit of choosing generalized speeds to be other than simply the
derivatives of the corresponding generalized coordinates can be seen in the
following example. If the orientation of a rigid body were to be described
using using Euler parameters or quaternions as coordinates, its angular
velocity in terms of time derivatives of those coordinates is relatively
complicated; it also requires a velocity constraint. Using generalized speeds
allows for the angular velocity to be expressed more simply as
\begin{align}
\label{eq:ex1}
{^N}\bs{\omega}^B = \omega_1 \uv{b}{1} + \omega_2 \uv{u}{2} + \omega_3 \uv{b}{3}
\end{align}
or, the angular velocity of rigid body $B$ in the reference frame $N$ is the
defined as the sum of three generalized--speed basis--vector products.
The derivatives of these generalized speeds will appear in the equations
of motion, rather than the twice time differentiated generalized coordinates
($\ddot{{q}}$'s).

A drawback of allowing such definitions can be seen when formulating the
kinematic differential equations, which relate the rate of change of the
generalized coordinates to the generalized speeds. These equations become more
complicated (in comparison to $\dot{q}_i = u_i$), but this is usually offset by
the significantly simpler dynamical equations of motion~\cite{Mitiguy1996}.

Use and understanding of Kane's method requires the use and understanding of
partial velocities and partial angular velocities. These are simply the
partial derivatives of the (angular) velocity vectors with respect to the
generalized speeds. For example, for the angular velocity in equation
(\ref{eq:ex1}), the partial angular velocities of body $B$ in reference frame
$N$ are
\[
  {^N}\bs{\omega}^B_{\omega_1} = \uv{b}{1} \quad \quad
  {^N}\bs{\omega}^B_{\omega_2} = \uv{b}{2} \quad \quad
  {^N}\bs{\omega}^B_{\omega_3} = \uv{b}{3}
\]
and it can be seen that the partial velocities represent the direction of
motion associated with each generalized speed. The geometric interpretations of
these partial (angular) velocities are discussed at length by
Lesser~\cite{Lesser1992}.

Taking the dot product of each partial velocity and both sides of Newton's
second law, $\bs{F}=m\bs{a}$ (or the rotational equivalent), only terms that
are parallel to the partial velocities remain; one scalar equation is generated
for each generalized speed. An important byproduct is that internal constraint forces
(non-contributing forces) imposed by objects such as pin or sliding joints no
longer need to be considered. The reason for this is that partial velocities
are \textit{by construction} perpendicular to forces of constraint. Constraint
forces can be included in the formulation, but will not appear in the final
equations of motion because of this very desirable property.

In summary, Kane's method allows for velocities to be defined in terms of
generalized speeds, allowing for simpler velocity expressions.  The dot product
of each partial velocity (the direction of motion associated with each
generalized speed) with Newton's second law (or Euler's equations) removes all
terms which are not related to the rate of change of each generalized speed.
This generally results in simple equations of motion, which are easier to form.

The mathematical formalism for applying Kane's method to multibody systems
follows. Consider a system composed of particles $P_1,...,P_h$, rigid bodies
$B_1,...,B_g$, with points of force application $Q_1,...,Q_k$, and reference
frames of torque application $E_1,...,E_c$, all defined relative to the
inertial reference frame $N$. This system has generalized coordinates
$q_1,...,q_n$ and generalized speeds $u_1,...,u_o$. Additionally, there are $l$
configuration constraints and $m$ velocity constraints.

In order to properly apply Kane's method, the velocities of each component in
the system need to be written as linear combinations of the generalized speeds.
The translational velocity of the particles are
\begin{align}
\label{eq:particle_translational}
{^N}\bs{v}^{P_i} = \sum^o_{j=1} {^N}\bs{v}^{P_i}_{u_j} u_j + {^N}\bs{v}^{P_i}_t
\quad \quad i=1,...,g
\end{align}
while the translational velocity of rigid body mass centers are
\begin{align}
\label{eq:rb_translational}
{^N}\bs{v}^{B_i^*} = \sum_{j=1}^o {^N}\bs{v}^{B_i^*}_{u_j} u_j +
{^N}\bs{v}^{B_i^*}_t \quad \quad i=1,...,h
\end{align}
and finally the translational velocity of points which have applied forces are
\begin{align}
\label{eq:points_translational}
{^N}\bs{v}^{Q_i} = \sum_{j=1}^o {^N}\bs{v}^{Q_i}_{u_j} u_j + {^N}\bs{v}^{Q_i}_t
\quad \quad i=1,...,k
\end{align}
Next, the angular velocity of rigid bodies are
\begin{align}
\label{eq:rb_rotational_bodies}
{^N}\bs{\omega}^{B_i} = \sum_{j=1}^o {^N}\bs{\omega}^{B_i}_{u_j} u_j +
{^N}\bs{\omega}^{B_i}_t \quad \quad i=1,...,h
\end{align}
and the angular velocity of reference frames which have applied torques are
\begin{align}
\label{eq:rb_rotational_frames}
{^N}\bs{\omega}^{E_i} = \sum_{j=1}^o {^N}\bs{\omega}^{E_i}_{u_j} u_j +
{^N}\bs{\omega}^{E_i}_t \quad \quad i=1,...,c
\end{align}
In these equations, each term $\bs{v}_t$ or $\bs{\omega}_t$ represents a
velocity or angular velocity component which is a prescribed function of time,
and has no dependence on generalized speeds (e.g., a motor or crank driven at a
specified rate).

For this system, we consider configuration constraints of the form
\begin{align}
\label{eq:configuration_constraints}
f_c(q, t) = 0
\end{align}
where $q\in\mathbb{R}^n, t\in\mathbb{R}$, and $f_c : \mathbb{R}^n \times
\mathbb{R} \mapsto \mathbb{R}^l$.  The velocity constraints are taken to have
the form
\begin{align}
\label{eq:velocity_constraints}
f_v(q, u, t) = 0
\end{align}
where $u\in\mathbb{R}^o$, $f_v : \mathbb{R}^n \times \mathbb{R}^o \times
\mathbb{R} \mapsto \mathbb{R}^m$, and $f_v$ is linear in $u$.  It is important
that the velocity constraints include the time-differentiated configuration
constraints or equivalent constraints which produce the same behavior.
Furthermore, velocity constraints should be written such that generalized
speeds and coordinates appear, but $\dot{q}$ terms do not (i.e., they should be
eliminated by appealing to the kinematic differential equations). Finally,
acceleration constraints are typically time-differentiated velocity constraints
(or similarly formed from kinematic considerations) and are assumed to have the
form
\begin{align}
  \label{eq:acceleration_constraints}
  f_a(q, \dot{q}, u, \dot{u}, t) = 0
\end{align}
where $f_a : \mathbb{R}^n \times \mathbb{R}^n \times \mathbb{R}^o \times
\mathbb{R}^o \times \mathbb{R} \mapsto \mathbb{R}^m$. In contrast to the
velocity constraints, our formulation permits the acceleration constraints to
involve $\dot{q}$ terms, although eliminating them using by appealing to the
kinematic differential equations presents no problems. By assumption, the
velocity constraints are linear with respect to $u$, so we introduce
\begin{align}
\label{eq:constraint_B}
  B &\triangleq \nabla_u f_v (q, u, t)
\end{align}
which implies that $B : \mathbb{R}^n \times \mathbb{R} \mapsto \mathbb{R}^m
\times \mathbb{R}^o$, i.e, $B$ is an $m \times o$ matrix whose entries depend
on $q$ and $t$. The velocity constraint equations may now be written as
\begin{align}
\label{eq:constraint_Bu0}
B u + f_{vt}(q, t) &= 0
\end{align}
where $f_{vt} : \mathbb{R}^n \times \mathbb{R} \mapsto \mathbb{R}^m$ arises if
there are explicit time varying terms in the velocity constraints. These
typically arise from specified quantities whose dynamics are being ignored
(e.g., a motor spinning at constant speed).

With these definitions established, Kane's method can be applied. In vector
form, Kane's holonomic dynamical equations are
\begin{align}
\label{eq:kanes_eq}
F + F^* = 0
\end{align}
where $F\in\mathbb{R}^o$ are the generalized active forces and
$F^*\in\mathbb{R}^o$ are the generalized inertia forces. The i-th element of
$F$ and $F^*$ are each associated with the i-th generalized speed. If Newton's
second law is written as $f - ma = 0$, $F$ is the multibody generalization of
$f$ and $F^*$ is the multibody generalization of $-ma$. As will be shown, these
forces are obtained by taking the dot product of the partial velocities and
partial angular velocities, as defined in (\ref{eq:particle_translational}) -
(\ref{eq:rb_rotational_frames}), with the resultant forces and torques
($\bs{R}$ and $\bs{T}$) and with inertial forces/torques ($\bs{R}^*$ and
$\bs{T}^*$).

The resultant force at a point is defined as the sum of all force vectors
acting directly on that point. The resultant torque on a reference frame is
defined similarly -- it is the sum of all torque vectors acting on that
reference frame. Distance forces do not need to be transformed into a resultant
force/torque pair for any components of the system; they only need to be
considered at the point of application (e.g., if a force $\bs{f}$ is the only
force applied to body $B$ at point $Q$, then $\bs{R}_{B^*}=\bs{0}$ and
$\bs{T}_B=\bs{0}$ but $\bs{R}_Q=\bs{f}$). The generalized active forces are
\begin{multline}
\label{eq:definition_F}
F =\\
\begin{bmatrix}
\displaystyle \sum_{i=1}^g \bs{R}_{B^*_i} \cdot {^N}\bs{v}^{B^*_i}_1 +
\sum_{i=1}^h \bs{R}_{P_i} \cdot {^N}\bs{v}^{P_i}_1 +
\sum_{i=1}^k \bs{R}_{Q_i} \cdot {^N}\bs{v}^{Q_i}_1 +
\sum_{i=1}^g \bs{T}_{B_i} \cdot {^N}\bs{\omega}^{B_i}_1 +
\sum_{i=1}^c \bs{T}_{E_i} \cdot {^N}\bs{\omega}^{E_i}_1 \\
\displaystyle \sum_{i=1}^g \bs{R}_{B^*_i} \cdot {^N}\bs{v}^{B^*_i}_2 +
\sum_{i=1}^h \bs{R}_{P_i} \cdot {^N}\bs{v}^{P_i}_2 +
\sum_{i=1}^k \bs{R}_{Q_i} \cdot {^N}\bs{v}^{Q_i}_2 +
\sum_{i=1}^g \bs{T}_{B_i} \cdot {^N}\bs{\omega}^{B_i}_2 +
\sum_{i=1}^c \bs{T}_{E_i} \cdot {^N}\bs{\omega}^{E_i}_2 \\
\displaystyle \vdots \\
\displaystyle \sum_{i=1}^g \bs{R}_{B^*_i} \cdot {^N}\bs{v}^{B^*_i}_o +
\sum_{i=1}^h \bs{R}_{P_i} \cdot {^N}\bs{v}^{P_i}_o +
\sum_{i=1}^k \bs{R}_{Q_i} \cdot {^N}\bs{v}^{Q_i}_o +
\sum_{i=1}^g \bs{T}_{B_i} \cdot {^N}\bs{\omega}^{B_i}_o +
\sum_{i=1}^c \bs{T}_{E_i} \cdot {^N}\bs{\omega}^{E_i}_o
\end{bmatrix}
\end{multline}

We now define the inertia forces and torques, $\bs{R}^*$ and $\bs{T}^*$. We
leave out the inertial frame $N$ from the expressions; it is assumed to be $N$.
The inertia force for particle $P$ is
\begin{align}
\label{eq:particle_gen_inertia}
\bs{R}^*_P \triangleq -m_P {^N}\bs{a}^P
\end{align}
while the inertia force and inertia torque for rigid body $B$ is
\begin{align}
\label{eq:rb_translational_gen_inertia}
\bs{R}^*_{B^*} &\triangleq -m_B {^N}\bs{a}^{B^*} \\
\label{eq:rb_rotational_gen_inertia}
\bs{T}^*_B &\triangleq -{^N}\bs{\alpha}^B \cdot \bs{I}^{B/B^*} -
{^N}\bs{\omega}^B \times \bs{I}^{B/B^*} \cdot {^N}\bs{\omega}^B
\end{align}
Where $\bs{I}^{B/B^*}$ is the central inertia dyadic of the rigid body
$B$ about its mass center $B^*$~\cite{Kane1985}. The generalized inertia forces
are
\begin{equation}
\label{eq:definition_Fstar}
\mathbf{F}^* =
\begin{bmatrix}
\displaystyle \sum_{i=1}^g \bs{R}^*_{B^*_i} \cdot {^N}\bs{v}^{B^*_i}_1 +
\sum_{i=1}^h \bs{R}^*_{P_i} \cdot {^N}\bs{v}^{P_i}_1 +
\sum_{i=1}^g \bs{T}^*_{B_i} \cdot {^N}\bs{\omega}^{B_i}_1 \\
\displaystyle \sum_{i=1}^g \bs{R}^*_{B^*_i} \cdot {^N}\bs{v}^{B^*_i}_2 +
\sum_{i=1}^h \bs{R}^*_{P_i} \cdot {^N}\bs{v}^{P_i}_2 +
\sum_{i=1}^g \bs{T}^*_{B_i} \cdot {^N}\bs{\omega}^{B_i}_2 \\
\displaystyle \vdots \\
\displaystyle \sum_{i=1}^g \bs{R}^*_{B^*_i} \cdot {^N}\bs{v}^{B^*_i}_o +
\sum_{i=1}^h \bs{R}^*_{P_i} \cdot {^N}\bs{v}^{P_i}_o +
\sum_{i=1}^g \bs{T}^*_{B_i} \cdot {^N}\bs{\omega}^{B_i}_o
\end{bmatrix}
\end{equation}

All the terms in (\ref{eq:kanes_eq}) are now defined, but this equation is
valid only if there are no velocity constraints. If there are velocity
constraints, the equations must be transformed. As we present them, Kane's
nonholonomic dynamical equations will be of dimension $o - m$, where $o$ is the
total number of generalized speeds and $m$ is the number of velocity
constraints. However, these $o-m$ equations generally involve all $o$ speeds
(we assume the dependent speeds and their time derivatives have \textit{not}
been algebraically eliminated). In order to obtain the nonholonomic dynamical
equations, however, a choice must be made as to which speeds will be dependent.
The methods for doing this are described extensively in~\cite{Reckdahl1996} and
described briefly in \autoref{model:dynamics}.

We assume the $o$ generalized speeds are ordered $u = [u_i, u_d]^T$, where
$u_i\in\mathbb{R}^{o-m}, u_d\in\mathbb{R}^{m}$ are the independent and
dependent speeds, respectively. The velocity constraint Jacobian matrix $B$ can
be similarly rearranged as $B = [B_i, B_d]$, where $B_i\in \mathbb{R}^{m \times
o-m}$ and $B_d \in \mathbb{R}^{m \times m}$. With this in mind, equation
(\ref{eq:constraint_Bu0}) can be written as
\begin{align}
{B}_i {u}_i + {B}_d {u}_d + f_{vt}({q}, t) &= 0 \\
\implies {u}_d &= -{B}_d^{-1} {B}_i {u}_i - f_{vt}({q}, t)
\end{align}
For convenience, we define
\begin{align}
\label{eq:constraint_A}
A \triangleq - B_{d}^{-1} {B}_i
\end{align}
and note that $A\in\mathbb{R}^{m \times (o - m)}$. To constrain the
generalized active and inertia forces, we partitioned them in a similar
manner
\begin{align}
\label{eq:F_Fstar_rewrite}
F = \begin{bmatrix} F_i \\ F_d \end{bmatrix} \quad
\quad F^* = \begin{bmatrix} F^*_i \\ F^*_d
\end{bmatrix}
\end{align}
where $F_i, F_i^*\in\mathbb{R}^{o-m}, F_d, F_d^*\in\mathbb{R}^{m}$, allowing
the nonholonomic generalized forces to be written as
\begin{align}
\label{eq:F_Fstar_nonholonomic}
\tilde{F} = F_i + A^T F_d \quad \quad
\tilde{F}^* = F_i^* + A^T F_d^*
\end{align}
where $\tilde{F}, \tilde{F}^*\in\mathbb{R}^{o-m}$ are the nonholonomic
generalized active and nonholonomic generalized inertia forces, respectively.
This allows Kane's nonholonomic dynamical equations to be written as
\begin{align}
\label{eq:kanes_eq_nonholonomic}
\tilde{F} + \tilde{F}^* = 0
\end{align}
This process of constraining the equations of motion reduces the number of
equations from $o$ to $o-m$. However, the (\ref{eq:kanes_eq_nonholonomic})
still contain $o$ unknowns ($\dot{u}_1,...,\dot{u}_o$). By augmenting
(\ref{eq:kanes_eq_nonholonomic}) with the acceleration constraint equations
(\ref{eq:acceleration_constraints}), we obtain $o$ equations in $o$ unknowns.
Note that equations (\ref{eq:kanes_eq_nonholonomic}) and
(\ref{eq:acceleration_constraints}) are linear in the $\dot{u}_i$'s. The
augmented system of equations is
\begin{align}
\label{eq:F_Fstar_f_a}
\begin{bmatrix}
\tilde{F} + \tilde{F}^* \\
f_a (q, \dot{q}, u, \dot{u}, t)
\end{bmatrix} = 0
\end{align}

For convenience, we summarize the critical equations in Table
\ref{table:assumptions}.
\begin{table}[htbp]
  \centering
  \begin{tabular}[c]{l l l}
    \toprule
    Quantity & Space & Description\\
    \midrule
    $q,\dot{q}$ & $\mathbb{R}^n$ & Coordinates and their time derivatives\\
    $u, \dot{u}$ & $\mathbb{R}^o$ & Speeds and their time derivatives\\
    $r$ & $\mathbb{R}^s$ & Exogenous inputs \\
    \bottomrule
  \end{tabular}
  \begin{tabular}[c]{r @{ $=$ } l l}
    \multicolumn{3}{c}{ } \\
    \toprule
    \multicolumn{2}{c}{Equation} & Description \\
    \midrule
    $f_{c}(q, t)$ & $0$ & Configuration constraints \\
    $f_{v}(q, u, t)$ & $0$ & Velocity constraints \\
    $f_{a}(q, \dot{q}, u, \dot{u}, t)$ & $0$ & Acceleration constraints \\
    $f_{0}(q, \dot{q}, t) + f_{1}(q, u, t)$ &
    $0$ & Kinematic differential equations \\
    $f_{2}(q, \dot{u}, t) + f_{3}(q, \dot{q}, u, r, t)$ & $0$ & Dynamic differential equations\\
    \bottomrule
  \end{tabular}
  \caption{Constrained multibody system governing definitions and equations}
  \label{table:assumptions}
\end{table}

The only new terms are $f_0$, $f_1$, $f_2$, and $f_3$. These terms are
introduced for notational convenience when deriving the linearization
procedure. The $n$ kinematic differential equations are arranged so all terms
appear to the left of the equality and arranged into
$f_0:\mathbb{R}^{n}\times\mathbb{R}^{n}\times\mathbb{R}\mapsto\mathbb{R}^n$ and
$f_0:\mathbb{R}^{n}\times\mathbb{R}^{o}\times\mathbb{R}\mapsto\mathbb{R}^n$,
depending on whether each term has a ${u}$ or $\dot{q}$ present. The same
organizational scheme is applied to the $o-m$ dynamic differential equations,
where
$f_2:\mathbb{R}^n\times\mathbb{R}^o\times\mathbb{R}\times\mapsto\mathbb{R}^{o-m}$
and
$f_3:\mathbb{R}^n\times\mathbb{R}^n\times\mathbb{R}^o\times\mathbb{R}^s\times\mathbb{R}\times\mapsto\mathbb{R}^{o-m}$;
if a term contains a $\dot{u}$ it is placed into $f_2$ and if not it is placed
into $f_3$. The motivation for this organizational scheme will be made apparent
in Section \ref{sec:derivations}.

\section{Rolling disk}
\label{sec:example}
To illustrate Kane's method in the presence of configuration and velocity
constraints, we consider a thin disk $C$ rolling without slip on a horizontal
plane. The dextral unit vectors $\hat{c}_x, \hat{c}_y, \hat{c}_z$ are fixed to $C$
with $\hat{c}_y$ perpendicular to the disk plane. Let $r$ and $m$ be the
disk radius and mass, and assume a thin disk mass distribution so that
$I_{xx}=I_{zz}=mr^2/4$ and $I_{yy} = mr^2/2$. Take the inertial (Newtonian)
frame $N$ to be similarly equipped with dextral unit vectors $\hat{n}_x,
\hat{n}_y, \hat{n}_z$, with $\hat{n}_z$ perpendicular to the ground plane
(downwards) and aligned with the local gravitational field. To orient the disk,
first align $C$ with $N$, then apply successive body fixed ZXY rotations:
yaw $q_1$, lean $q_2$, and spin $q_3$.  Denote by $A$ and $B$ the two frames
associated with the first two intermediate rotations in the sequence; we refer
to these as the instantaneous yaw and lean frames, respectively. The unit
vector, $\hat{b}_z$ fixed in the $B$ frame, is parallel to the disk plane and
aligned with the position vector from the disk center $C^*$ to the lowest point
of the disk $P^*$.

Traditionally, to locate the center of the disk $C^*$
relative to the inertial origin $N^*$, two coordinates are used to locate the
contact point in the ground plane; these two coordinates and the lean angle
and yaw angles determine the location of the center of the disk. The advantage of this
approach is that the choice of coordinates guarantees that the disk remain in
contact with the ground plane.

To illustrate how dependent coordinates must be
accounted for when linearizing the equations of motion, we purposefully locate
the center of the disk $C^*$ relative to the inertial origin $N^*$ with a
non-minimal choice of coordinates
\begin{equation*}
  \bs{r}^{C^*/N^*} = q_4 \uv{n}{x} + q_5 \uv{n}{y} + q_6 \uv{n}{z}{n}
\end{equation*}
which results in the configuration constraint $\mathbf{f}_c$
\begin{equation}
  \label{rd:f_c}
  r\cos{q_2} + q_6 = 0
\end{equation}
which must be satisfied for the disk to remain in contact with the ground.
While this constraint is easily avoided by appropriate choice of coordinates,
it serves to illustrate considerations which must be made when analyzing
systems in which there is no obvious way to eliminate configuration constraints.

Again to demonstrate how velocity constraints must be accounted for when
obtaining linearized equations of motion, we define the velocity of $C^*$ in
$N$ with a non-minimal choice of speeds, defined in the body-fixed ($C$) frame.
The angular velocity of $C$ in $N$, however, is defined in the intermediate
lean frame $B$.
\begin{align}
  \label{v_u}
  {^N}\bs{v}^{C^*} &= u_4 \uv{c}{x} + u_5 \uv{c}{y} + u_6 \uv{c}{z} \\
  \label{w_u}
  {^N}\bs{\omega}^C &= u_1 \uv{b}{x} + u_2 \uv{b}{y} + u_3 \uv{b}{z}
\end{align}
The unconstrained partial angular velocity and partial velocity of $C^*$,
respectively, are
\begin{align}
  {^N}\bs{v}^{C^*}_u &= [\bs{0}, \bs{0}, \bs{0}, \uv{c}{x}, \uv{c}{y}, \uv{c}{z}] \\
  {^N}\bs{\omega}^C_u &= [\uv{b}{x}, \uv{b}{y}, \uv{b}{z}, \bs{0}, \bs{0}, \bs{0}]
\end{align}
where we present the partial velocities as a $1\times6$ matrix whose entries
are populated with standard 3-vectors. Given these definitions, the velocity of
the lowest point of the disk $P^*$ is
\begin{align*}
  {^N}\bs{v}^{P^*} &= {^N}\bs{v}^{C^*} + {^N}\bs{\omega}^{C} \times \bs{r}^{P^*/C^*} \\
  &= u_4\uv{c}{x} + u_5\uv{c}{y} + u_6\uv{c}{z} + r u_2
  \uv{b}{x} - r u_1 \uv{b}{y} \\
  &= (r u_2 \cos(q_3) + u_4) \uv{c}{x} + (-r u_1 + u_5)\uv{c}{y} + (r u_2 \sin(q_3) +
  u_6) \uv{c}{z}
\end{align*}
where we have made use of the fact that $\bm{r}^{P^*/C^*} = r\bm{b}_z$.
Under the assumption of pure rolling this immediately yields three velocity
constraint equations which make up $f_v(q, u, t) = 0$
\begin{subequations}
\label{rd:f_v}
\begin{align}
  \begin{bmatrix}
    r u_2 \cos(q_3) + u_4 \\
    -r u_1 + u_5 \\
    r u_2 \sin(q_3) + u_6 \\
  \end{bmatrix} &=
  \begin{bmatrix} 0 \\ 0 \\ 0 \end{bmatrix}
\end{align}
\end{subequations}
These equations are linear in the $u_i$ terms, nonlinear in the $q_i$ terms,
involve geometric system parameters (but not mass or inertial parameters), and
do not explicitly involve $\dot{q}_i$ terms. This structure will be taken
advantage of in Section \ref{sec:derivations}.

At this point, the reader familiar with the rolling disk problem is certainly
wondering why we have chosen such a diabolical set of coordinates and speeds.
In this simple example, there is an {\bf \textit{obvious and minimal}} choice of
coordinates and speeds ($q_6, u_4, u_5, u_6$, should be dependent; this choice
will be valid for all parameters and configurations; further, the derivation of
the equations of motion can be done without ever introducing dependent quantities),
for some systems this is not the case (e.g., Stewart's platform, bicycle). The
numeric values of system parameters and the configurations in which the system
will operate will determine which coordinates and speeds can be taken to be
dependent (and hence potentially eliminated by algebraic manipulations).
However, it may not be possible \textit{apriori} to determine easily which
coordinates and speeds should be taken as dependent; further, some systems may
operate in distinct enough regions of the configuration space that one
\textit{must} use different choices of dependent coordinates and/or speeds as
the system moves from one region to another. The purpose of our complex
choice of coordinates and speeds is to illustrate, in the context of a familiar
example, how constraints must be taken into account when linearizing equations
of motion. It is our hope that by doing this for a well known and relatively
simple example, readers can apply the same techniques to more complicated
systems where its use is more appropriate or necessary.

Time differentiating the velocity constraint equations yields the acceleration
constraint equations, $f_a(q, \dot{q}, u, \dot{u}, t) = 0$
\begin{subequations}
\label{rd:f_a}
\begin{align}
  \begin{bmatrix}
    -r u_{2} \sin(q_{3}) \dot{q}_{3} + r \cos(q_{3}) \dot{u}_{2} + \dot{u}_{4}
    \\
    - r \dot{u}_{1} + \dot{u}_{5} \\
    r u_{2} \cos(q_{3}) \dot{q}_{3} + r \sin(q_{3}) \dot{u}_{2} + \dot{u}_{6}
  \end{bmatrix}
  &=
  \begin{bmatrix} 0 \\ 0 \\ 0 \end{bmatrix}
\end{align}
\end{subequations}
which must also be satisfied during general motions. There are two types of
terms in these equations; 1) terms involving $\dot{u}_i$'s and $q_i$'s, and 2)
terms involving $\dot{q}_i$'s, $u_i$'s, and $q_i$'s. This structure will be
taken advantage of subsequently.

The kinematic differential equations relate the time derivatives of the
coordinates and the generalized speeds. They are obtained by equating
velocities expressed in terms of time-differentiated generalized coordinates
with velocities expressed in terms of generalized speeds. From the addition
theorem for angular velocity, the angular velocity of $C$ is
\begin{equation}
  \label{w_qdot}
  {^N}\bs{\omega}^C = \dot{q}_1 \uv{n}{z} + \dot{q}_2 \uv{a}{x} + \dot{q}_3 \uv{b}{y}
\end{equation}
while time differentiating $r^{C^*}$ in $N$ yields
\begin{equation}
  \label{v_qdot}
  {^N}\bs{v}^{C^*} = \dot{q}_4 \uv{n}{x} + \dot{q}_5 \uv{n}{y} + \dot{q}_6 \uv{n}{z}
\end{equation}
Equating (\ref{w_u}) with (\ref{w_qdot}) and (\ref{v_u}) with (\ref{v_qdot}),
and resolving these vector equations into the $B$ frame, and rearranging so
that all terms appear to the left of the equality sign, we obtain
\begin{align}
    \label{rd:f_0_f_1}
\underbrace{\left[\begin{matrix}\dot{q}_{2}\\\sin\left(q_{2}\right)
    \dot{q}_{1} + \dot{q}_{3}\\\cos\left(q_{2}\right)
    \dot{q}_{1}\\\dot{q}_{4}\\\dot{q}_{5}\\\dot{q}_{6}\end{matrix}\right]}_{f_0}
    + 
\underbrace{\left[\begin{matrix}- u_{1}\\- u_{2}\\- u_{3}\\r u_{1}
    \sin\left(q_{1}\right) \cos\left(q_{2}\right) +
    r u_{2} \cos\left(q_{1}\right)\\- r u_{1}
    \cos\left(q_{1}\right) \cos\left(q_{2}\right) +
    r u_{2} \sin\left(q_{1}\right)\\- r u_{1}
    \sin\left(q_{2}\right)\end{matrix}\right]}_{f_1}
    = \left[\begin{matrix} 0\\ 0\\ 0\\ 0\\ 0\\ 0\end{matrix}\right]
\end{align}
The translational acceleration of $C^*$ and the angular acceleration of $C$,
relative to $N$, are
\begin{align}
    {^N}\bs{a}^{C^*} =& (-(u_1 \sin(q_3) + u_3 \cos(q_3)) u_5 + u_2 u_6 +
    \dot{u}_4) \uv{c}{x} \notag \\
                      & + ((u_1 \sin(q_3) + u_3 \cos(q_3)) u_4 - (u_1
                      \cos(q_3) - u_3 \sin(q_3)) u_6 + \dot{u}_5) \uv{c}{y}
                         \notag\\
                      & + ((u_1 \cos(q_3) - u_3 \sin(q_3)) u_5 - u_2 u_4 +
                      \dot{u}_6) \uv{c}{z} \\
                      {^N}\bs{\alpha}^{C} =& (-u_2 u_3 + u_3^2 \tan(q_2) + \dot{u}_1) \uv{b}{x}
                      + \dot{u}_2 \uv{b}{y} + (u_1 u_2 - u_1 u_3 \tan(q2) +
                      \dot{u}_3) \uv{b}{z}
\end{align}

The mass of the disk is $m$, and the inertia dyadic of the disk can is
\begin{align}
  \bs{\mathbf{I}}^{C/C^*} = \frac{m r^2}{4} \uv{c}{x}\uv{c}{x} +
    \frac{m r^2}{2} \uv{c}{y}\uv{c}{y} + \frac{m r^2}{4} \uv{c}{z}\uv{c}{z}
\end{align}
Using equations (\ref{eq:rb_translational_gen_inertia}) and
(\ref{eq:rb_rotational_gen_inertia}), $\bs{R}^*_{C^*}$ and $\bs{T}^*_C$ can be
written.
\begin{align}
    \bs{R}^*_{C^*} =& - m (- (u_{1} \sin(q_{3}) + u_{3}
                       \cos(q_{3})) u_{5} + u_{2} u_{6} +
                       \dot{u}_{4}) \uv{c}{x} \notag \\
                     & - m ((u_{1} \sin(q_{3}) + u_{3}
                       \cos(q_{3})) u_{4} - (u_{1}
                       \cos(q_{3}) - u_{3}
                       \sin(q_{3})) u_{6} + \dot{u}_{5})
                       \uv{c}{y} \notag \\
                     & - m ((u_{1} \cos(q_{3}) - u_{3}
                       \sin(q_{3})) u_{5} - u_{2} u_{4} +
                   \dot{u}_{6}) \uv{c}{z} \\
    \bs{T}^*_C =& \frac{m r^{2}}{4} (2 u_{1} u_{2} \sin(q_{3})
                   - u_{1} u_{3} \sin(q_{3}) \tan(q_{2})
                   + 2 u_{2} u_{3} \cos(q_{3}) \notag\\&\quad\quad- u_{3}^2
                   \cos(q_{3}) \tan(q_{2}) +
                   \sin(q_{3}) \dot{u}_{3} - \cos(q_{3})
                   \dot{u}_{1}) \uv{c}{x} \notag \\
                 & - \frac{m r^{2}}{2} \dot{u}_{2} \uv{c}{y} \notag \\
                 & + \frac{m r^{2}}{4} (- 2 u_{1} u_{2}
                   \cos(q_{3}) + u_{1} u_{3} \cos(q_{3})
                   \tan(q_{2}) + 2 u_{2} u_{3}
                   \sin(q_{3}) \notag\\&\quad\quad - u_{3}^2 \sin(q_{3})
                   \tan(q_{2}) - \sin(q_{3}) \dot{u}_{1}
                   - \cos(q_{3}) \dot{u}_{3}) \uv{c}{z}
\end{align}

The active forces and active torques are
\begin{align}
  \bs{R}_{C^*} &= m g \uv{n}{z} \\
  \bs{T}_C &= \bs{0}
\end{align}

Equations (\ref{eq:definition_F}), (\ref{eq:definition_Fstar}), and
(\ref{eq:kanes_eq}) can be used to construct the equations of motion.  For
brevity, we omit the results of each step involved. The resulting three dynamic
equations are
\begin{align}
 - \frac{m r}{4} \left(r \dot{u}_{1} + 4 \dot{u}_{5}\right) &=
 - m r ( g  \sin(q_2) - u_1 u_4 \sin(q_3) + \notag\\
 & \quad u_1 u_6 \cos(q_3) + (\frac{r u_2}{2} - \frac{r u_3}{4} \tan(q_2) - \notag \\
 & \quad\quad u_4 \cos(q_3) - u_6 \sin(q_3)) u_3 ) \label{rd:f_2_f_3_a} \\
\frac{m r}{2} \left(- r \dot{u}_{2} + 2
                \sin\left(q_{3}\right) \dot{u}_{6} + 2 \cos\left(q_{3}\right)
                \dot{u}_{4}\right) &= m r ( u_{2} u_{4}
                \sin\left(q_{3}\right) - u_{2} u_{6}
                \cos\left(q_{3}\right) +\notag\\
                & \quad u_{3} u_{5}) \label{rd:f_2_f_3_b} \\
- \frac{m r^{2}}{4} \dot{u}_{3} &= \frac{m r^{2}}{4} \left(2 u_{2} - u_{3} \tan\left(q_{2}\right)\right) u_{1} \label{rd:f_2_f_3_c}
\end{align}
The terms on the left of the equality are $f_2$, the terms on the right of the
equality are $-f_3$ (they are written as $f_2 = -f_3$ here purely for
formatting reasons).

The twelve unknown quantities appearing in the nine kinematic and dynamic
differential equations are $\dot{q}_{1-6}$ and $\dot{u}_{1-6}$. The three
acceleration constraint equations provide the final three equations which allow
for all twelve unkowns to be solved. Combining (\ref{rd:f_0_f_1}),
(\ref{rd:f_2_f_3_a}-\ref{rd:f_2_f_3_c}), and (\ref{rd:f_a}), the complete second order differential
equations can be written.
\begin{align}
\label{rd:ode}
\begin{bmatrix} \mathbf{f}_0 + \mathbf{f}_1\\
                \mathbf{f}_2 + \mathbf{f}_3\\
                \mathbf{f}_a \end{bmatrix} = \mathbf{0}
\end{align}

The naive approach to linearizing these equations of motion would be to solve
for the ($\dot{q}_i$, $\dot{u}_i$) terms to construct the right-hand side of
\begin{align}
\begin{bmatrix}\dot{{q}} \\ \dot{{u}}\end{bmatrix} =
    \mathbf{f}({q}, {u}, t)
\end{align}
and take the Jacobian of $\mathbf{f}$ with respect to $[{q} \quad {u}]^T$.
However, this will give incorrect results. As discussed in~\cite{Schwab2003},
when $m, r,$ and $g$ are taken to be unity, and the system is linearized about
the upright steady rolling condition, the critical speed is $v \triangleq
-r\dot{q}_3 =\pm\frac{1}{\sqrt{3}}$. When following the naive approach, and
evaluating the Jacobian at the same operating conditions and parameters, eight
of the twelve eigenvalues are identically zero while the remaining four are
\begin{align}
  \label{eq:evals_incorrect}
  \lambda_{1,2}=\pm\frac{\sqrt{6}}{3}\sqrt{-v^2},
  \quad \lambda_{3,4} = \pm\sqrt{\frac{4}{5} - \frac{12}{5} v^2}
\end{align}
which demonstrates the incorrectness of this naive approach (since
$v=\pm\frac{1}{\sqrt{3}}$ is not a critical point of these eigenvalues).
Further, the fact that twelve eigenvalues are obtained should be an alert that
something is incorrect since the number of independent quantities is only eight
(five coordinates and three speeds). We now outline a linearization procedure
which addresses this issue; we revisit this example in Section
\ref{sec:example_revisited}.

\section{Derivation of linearization procedure}
\label{sec:derivations}
In response to the need we have demonstrated, we present a linearization
procedure that properly accounts for system constraints. Taking the Jacobian
of the right hand side of the ODE's as we did at the end of the previous
section is incorrect because it fails to apply the chain rule and thereby
properly account for the relationships imposed by configuration, velocity, and
acceleration constraints. That it isn't immediately obvious that the chain rule
needs to be applied is a byproduct of the commonly use notation which doesn't
make it explicitly clear that dependent coordinates and dependent speeds are not
only functions of time, but also functions of the independent coordinates and
independent speeds. These dependent terms should in fact be written as
\begin{align}
\label{eq:q_d_redefined}
{q}_d (t) \to {q}_d ({q}_i, t) \\
\label{eq:u_d_redefined}
{u}_d (t) \to {u}_d ({q}_i, {u}_i, t)
\end{align}
While this might seem obvious, no previous author appears to make this
explicitly clear when presenting techniques for symbolically linearizing
equations of motion which are subject to constraints. While the concept is
simple in principle, correctly accounting for all quantities is tedious and
error prone. Having a high level, systematic procedure that can be implemented
reliably in software is therefore a strong argument for the detailed and
explicit procedure we present.

We begin with a first order Taylor series expansion of the equations in Table
\ref{table:assumptions} about $q=q^*$, $\dot{q}=\dot{q}^*$, $u=u^*$,
$\dot{u}=\dot{u}^*$, $r=r^*$; it is assumed that all of the equations in Table
\ref{table:assumptions} are satisfied by these quantities (i.e., the system is
satisfies the constraint equations and Newton's 2nd law).  In the interest of
brevity, we omit writing this point of linearization in each gradient in the
calculations below; all are evaluated at this point. Expansion of the three
constraint equations, keeping only first order terms, yields
\begin{align}
  \label{eq:configuration_expansion}
  f_{c}(q, t) &\approx \underbrace{f_{c}(q^*, t)}_{0} +
  \nabla_{q}f_{c} \delta q\\
  \label{eq:velocity_expansion}
  f_{v}(q, u, t) &\approx \underbrace{f_{v}(q^*,
  u^*, t)}_{0} +  \nabla_{q}f_{v} \delta q +
  \nabla_{u}f_{v} \delta u \\
  \label{eq:acceleration_expansion}
  f_{a}(q, \dot{q}, u, \dot{u}, t) &\approx
  \underbrace{f_{a}(q^*, \dot{q}^*, u^*, \dot{u}^*,
t)}_{0} +  \nabla_{q}f_{a} \delta q +
\nabla_{\dot{q}}f_{a}
 \delta \dot{q} \notag\\
&+ \nabla_{u}f_{a} \delta u + \nabla_{\dot{u}}f_{a}
\delta \dot{u}
\end{align}
The first terms are identically zero because of the assumption that the
point of linearization satisfies the constraints.  The Taylor series expansion
of the kinematic differential equations is
\begin{align}
  \label{eq:f0_expansion}
  f_{0}(q, \dot{q}, t) &\approx f_{0}(q^*,
  \dot{q}^*, t) + \nabla_{q}f_{0} \delta{q} +
  \nabla_{\dot{q}}f_{0} \delta\dot{q}\\
  \label{eq:f1_expansion}
  f_{1}(q, u, t) &\approx f_{1}(q^*,
  u^*, t) + \nabla_{q}f_{1} \delta{q} +
  \nabla_{u}f_{1} \delta{u}
\end{align}
Summing (\ref{eq:f0_expansion}) and (\ref{eq:f1_expansion}) and recognizing
that the sum of the first term on the right hand side of each equation must
equal zero, we obtain
\begin{align}
  \label{eq:f0_plus_f1_expansion}
  f_{0}(q, \dot{q}, t) + f_{1}(q, u, t) &\approx
  \nabla_{q}(f_{0} + f_{1}) \delta{q} +
  \nabla_{\dot{q}}f_{0} \delta\dot{q} +
  \nabla_{u}f_{1} \delta{u}
\end{align}
Similarly, a Taylor series expansion of the dynamic differential equations, we
obtain
\begin{align}
  \label{eq:f2_expansion}
  f_{2}(q, \dot{u}, t) &\approx
      f_{2}(q^*, \dot{u}^*, t) +
      \nabla_{q}f_{2} \delta{q}
      + \nabla_{\dot{u}}f_{2} \delta\dot{u}\\
  f_{3}(q, \dot{q}, u, r, t) &\approx
  f_{3}(q^*, \dot{q}^*, u^*, r^*, t) +
  \nabla_{q}f_{3} \delta{q}\notag\\
  \label{eq:f3_expansion}
  &+ \nabla_{\dot{q}}f_{3} \delta\dot{q}
  + \nabla_{u}f_{3} \delta u
  + \nabla_{r}f_{3} \delta{r}
\end{align}
Summing (\ref{eq:f2_expansion}) and (\ref{eq:f3_expansion}) and recognizing
that the sum of the first term on the right hand sides of these equations must
equal zero, we obtain
\begin{align}
  f_{2}(q, \dot{u}, t) + f_{3}(q, \dot{q},
  u, r, t) &\approx \nabla_{q}(f_2 + f_3)
  \delta{q} + \nabla_{\dot{q}}f_{3} \delta\dot{q}\notag\\
  \label{eq:f2_plus_f3_expansion}
  &+ \nabla_{u}f_{3} \delta{u} +
  \nabla_{\dot{u}}f_{2} \delta\dot{u} + \nabla_{r}f_{3} \delta{r}
\end{align}

Equating the right hand sides of equations (\ref{eq:f0_plus_f1_expansion}),
(\ref{eq:acceleration_expansion}),
and (\ref{eq:f2_plus_f3_expansion}) to zero (as in Table
\ref{table:assumptions}), and introducing the following definitions
\begin{align}
\label{eq:quant_to_compute}
  \begin{array}{llcll}
    \tilde{M}_{qq}  &\triangleq \nabla_{\dot{q}}f_0 & \quad &
    \tilde{M}_{uqc} &\triangleq \nabla_{\dot{q}}f_a \\
    \tilde{M}_{uuc} &\triangleq \nabla_{\dot{u}}f_a & \quad &
    \tilde{M}_{uqd} &\triangleq \nabla_{\dot{q}}f_3 \\
    \tilde{M}_{uud} &\triangleq \nabla_{\dot{u}}f_2 & \quad &
    \tilde{A}_{qq}  &\triangleq -\nabla_{q}(f_0 + f_1) \\
    \tilde{A}_{qu}  &\triangleq -\nabla_{u}f_1 & \quad &
    \tilde{A}_{uqc} &\triangleq - \nabla_{q} f_a \\
    \tilde{A}_{uuc} &\triangleq - \nabla_{u} f_a & \quad &
    \tilde{A}_{uqd} &\triangleq - \nabla_{q} (f_2 + f_3) \\
    \tilde{A}_{uud} &\triangleq - \nabla_{u} f_3 & \quad &
    \tilde{B}_{u}   &\triangleq -\nabla_{r}f_{3}
  \end{array}
\end{align}
enables the unconstrained linear state space equations to be written as
\begin{align}
  \label{eq:state_space_unconstrained}
  \left[
    \begin{array}{cc}
      \tilde{M}_{qq} & 0_{n \times o} \\
      \tilde{M}_{uqc} & \tilde{M}_{uuc} \\
      \tilde{M}_{uqd} & \tilde{M}_{uud}
    \end{array}
    \right]
    \left[
      \begin{array}{c}
        \delta \dot{q} \\
        \delta \dot{u}
      \end{array}
    \right]
   &=
   \left[
     \begin{array}{cc}
       \tilde{A}_{qq} & \tilde{A}_{qu} \\
       \tilde{A}_{uqc} & \tilde{A}_{uuc} \\
       \tilde{A}_{uqd} & \tilde{A}_{uud}
     \end{array}
   \right]
    \left[
      \begin{array}{c}
        \delta q \\
        \delta u
      \end{array}
    \right]
    +
    \left[
      \begin{array}{c}
        0_{(n + m) \times s} \\
        \tilde{B}_{u}
      \end{array}
    \right]
    \delta r
\end{align}
Equation (\ref{eq:state_space_unconstrained}) has a state space of dimension $n
+ o$, yet only $p = n - l + o - m$ of these quantities are independent.  To
address this issue, a smaller set of independent coordinates and speeds must be
selected. To this end, we partition the generalized coordinates and generalized
speeds as
\begin{equation*}
  \tilde{q} \triangleq \left[\begin{array}{cc}q_{i} &
      q_{d}\end{array}\right]^{T} =  P_{q}^{-1} q
      \qquad\qquad
  \tilde{u} \triangleq \left[\begin{array}{cc}u_{i} &
      u_{d}\end{array}\right]^{T} =  P_{u}^{-1} u
\end{equation*}
where $P_q \in \mathbb{R}^{n \times n}$ and $P_u \in \mathbb{R}^{o \times o}$
are invertible permutation matrices which map an ordering which has the
independent quantities ($q_{i}\in\mathbb{R}^{n-l},\,
u_{i}\in\mathbb{R}^{o-m})$ first, followed by the dependent quantities,
($q_{d}\in\mathbb{R}^{l},\, u_{d}\in\mathbb{R}^{m}$) to the original
ordering of the coordinates and speeds.  We use the notation $P_{qi}$ and
$P_{qd}$ to denote the first $n-l$ and last $l$ columns of $P_q$, respectively;
similarly, $P_{ui}$ is the first $o-m$ columns of $P_{u}$ while $P_{ud}$ is the
last $m$ columns of $P_u$.

Making use of $P_q$ and the assumption that equation
(\ref{eq:configuration_expansion}) is zero gives
\begin{align}
\nabla_{q}f_{c} \delta q &= \nabla_{q}f_{c} P_{q} \delta \tilde{q} \notag \\
   &= \nabla_{q}f_{c} P_{qi} \delta q_i +
  \nabla_{q}f_{c} P_{qd} \delta q_d\notag\\
  \implies \delta q_d &= -(\nabla_{q}f_{c} P_{qd})^{-1}
  (\nabla_{q}f_{c} P_{qi}) \delta q_i \notag\\
  \label{eq:delta_q}
  \implies \delta q &= \underbrace{\left[ I_{n \times n} - P_{qd}(\nabla_{q}
  f_{c} P_{qd})^{-1} \nabla_{q} f_{c} \right]
  P_{qi}}_{\triangleq C_0} \delta q_i
\end{align}
Making use of $P_q$, $P_u$, the assumption that equation
(\ref{eq:velocity_expansion}) is zero, and taking equation (\ref{eq:delta_q})
into account gives
\begin{align}
\nabla_{q}f_{v} \delta q + \nabla_{u}f_{v} \delta u
  &= \nabla_{q} f_{v} C_0 \delta q_i +\nabla_{u} f_{v}
  \delta P_u \tilde{u} \notag \\
  &=\nabla_{q} f_{v} C_0 \delta q_i + \nabla_{u} f_{v} P_{ui} \delta u_i +
\nabla_{u} f_{v} P_{ud} \delta u_d \notag\\
%
\implies \delta u_d &= -\left(\nabla_{u} f_{v}
P_{ud}\right)^{-1}\left[\nabla_{q}f_{v} C_0 \delta q_i +
  \nabla_{u} f_{v} P_{ui} \delta u_i \right]\notag\\
  \implies \delta u &= \underbrace{-P_{ud}(\nabla_{u} f_{v} P_{ud})^{-1}
  \nabla_{q} f_{v}}_{\triangleq C_1} C_0 \delta q_i \notag\\
  \label{eq:delta_u}
  &+ \underbrace{\left[I - P_{ud} (\nabla_{u}f_{v} P_{ud})^{-1} \nabla_{u}
  f_{v} \right] P_{ui}}_{\triangleq C_2} \delta u_i
\end{align}

Making use of equations (\ref{eq:delta_q}) and (\ref{eq:delta_u}), we can
rewrite equation (\ref{eq:state_space_unconstrained}) as
\begin{align}
  \label{eq:state_space_constrained}
  \left[
    \begin{array}{cc}
      \tilde{M}_{qq} & 0_{n \times o} \\
      \tilde{M}_{uqc} & \tilde{M}_{uuc} \\
      \tilde{M}_{uqd} & \tilde{M}_{uud}
    \end{array}
    \right]
    \left[
      \begin{array}{c}
        \delta \dot{q} \\
        \delta \dot{u}
      \end{array}
    \right]
   &=
   \left[
     \begin{array}{cc}
       (\tilde{A}_{qq} + \tilde{A}_{qu} C_1 ) C_0 & \tilde{A}_{qu} C_2 \\
       (\tilde{A}_{uqc} + \tilde{A}_{uuc} C_1 ) C_0 & \tilde{A}_{uuc} C_2\\
       (\tilde{A}_{uqd} + \tilde{A}_{uud} C_1 ) C_0 & \tilde{A}_{uud} C_2
     \end{array}
   \right]
    \left[
      \begin{array}{c}
        \delta q_i \\
        \delta u_i
      \end{array}
    \right]
    \notag \\
    &+\left[
      \begin{array}{c}
        0_{(n+m) \times s} \\
        \tilde{B}_{u}
      \end{array}
    \right]
    \delta r
\end{align}
This definitively establishes how the first time derivatives of coordinates and
speeds (independent \textit{and} dependent) depend, to first order, upon a
selection of independent coordinates and independent speeds, for an arbitrary
point of linearization. Note that the only requirement on this point of
linearization is that it satisfy all the equations in Table
\ref{table:assumptions}; it may or may not be an equilibrium point.

\section{Rolling disk, revisited}
\label{sec:example_revisited}
As shown at the end of Section \ref{sec:example}, obtaining correct linearized
equations in the presence of constraints requires a technique other than
straightforward calculation of the Jacobian. In this section, we demonstrate
that our linearization procedure yields eigenvalues which match published
results~\cite{Schwab2003,Kane1985,Neimark1972}. The first step in the procedure
is to form the matrices in Equation (\ref{eq:quant_to_compute}). Once obtained,
these matrices can be evaluated at the equilibrium conditions and parameters of
interest. We follow the standard approach to finding the equilibrium conditions
by \textit{choosing} the independent quantities and solving the constraint
equations for the dependent quantities.

We first consider the case of upright steady cruise and begin by choosing the
independent coordinates to be zero ($q_i^* = 0$, $i = 1,\dots,5$), which
implies (by appealing to the configuration constraint) that $q_6^* = -r
\cos{q_2} = -r$.  This corresponds to the disk upright, the lowest point of the
disc in contact with the ground, and the disk heading aligned with the
$\hat{n}_x$ unit vector.  Next, we solve the velocity constraint equations for
the dependent speeds in terms of the independent ones, and substitute these
into the kinematic differential equations. This yields six equations with nine
unknowns: $u_i (i=1,2,3)$ and $\dot{q}_i (i=1,\dots6)$. We \textit{choose} yaw
rate $\dot{q}_1^* = 0$, lean rate $\dot{q}_2^* = 0$, let spin rate
$\dot{q}_3^*$ be a free variable, and solve for the remaining six unknowns.
This yields $u_1^* = u_3^* = 0$, $u_2^* = \dot{q}_3^*$, $\dot{q}_4^* =
-r\dot{q}_3^*$, $\dot{q}_5^* = \dot{q}_6^* = 0$. Back substituting the first
three of these results into the velocity constraint equations yields $u_4^* =
-r\dot{q}_3^*$, $u_5^* = u_6^* = 0$. Finally, by evaluating the acceleration
constraints $f_a$ and the dynamic equations $f_2 + f_3$ at these conditions, we
can solve for $\dot{u}_i^*$, $i = 1,\dots6$. We obtain $\dot{u}_1^* =
\dot{u}_2^* = \dot{u}_3^* = \dot{u}_4^* = \dot{u}_5^* = 0$, and $\dot{u}_6^* =
-r \dot{q}_3^{*2}$. The upright equilibrium conditions are thus parameterized
in terms of the disc spin rate $\dot{q}_3$; for this upright configuration
($q_2 = 0$) it is convenient to introduce the forward speed $v \triangleq
-r\dot{q}_3^*$.

Evaluating the matrices in equations (\ref{eq:state_space_constrained}) at
these equilibrium conditions and subsequently solving these equations for
$\delta\dot{{q}}$ and $\delta\dot{{u}}$ yields the linearized
relationship between the time derivatives of all state variables and the
independent state variables. By taking only the rows associated with the
independent states, the linear relationship between the independent states and
their time derivatives are formed. The eigenvalues of this coefficient matrix
may be computed symbolically. Six of the eight eigenvalues of this matrix are
zero, and the remaining two are
\begin{align}
\label{eq:upright_evals}
  \lambda_{1,2} &= \pm \frac{2\sqrt{1 - 3v^2}}{\sqrt{5}}
\end{align}
which has critical points at $v^*=\pm\frac{1}{\sqrt{3}}$ and matches previously
published results~\cite{Schwab2003,Kane1985,Neimark1972}. For $|v| < v^*$,
the disk is unstable, but for $|v| \geq v^*$, the eigenvalues are purely
imaginary and are hence marginally stable. We omit the details of these
calculations and direct the reader to the electronic supplementary material.

A more general analysis of the stability of the rolling disk equilibria
considers the case where the disk lean $q_2$ is constant but not necessarily
zero. To satisfy the dynamics, the yaw rate $\dot{q}_1$ and spin rate
$\dot{q}_3$ must be chosen to satisfy
\begin{align}
  \frac{g}{r}\sin{(q_2)}  + \frac{3}{2}\cos{(q_2)} \dot{q}_3 \dot{q}_1 +
  \frac{5}{4}\cos{(q_2)}\sin{(q_2)} \dot{q}_1^2
 &= 0
\end{align}
which is a quadratic equation in the yaw rate $\dot{q}_1$ with roots
\begin{align}
\dot{q}_1 &= \frac{r}{2 g \sin\left(q_{2}\right)} \left( - \frac{3}{2} \dot{q}_{3}\cos\left(q_{2}\right) \pm \sqrt{- \frac{5 g}{r} \sin^{2}\left(q_{2}\right) \cos\left(q_{2}\right) + \frac{9}{4} \dot{q}_{3}^{2} \cos^{2}\left(q_{2}\right)} \right)
\end{align}
To be physically meaningful, these roots must be real, which gives rise to the following additional requirement
\begin{align}
  \dot{q}_3^2 &\geq \frac{20g}{9r}\sin{(q_2)} \tan{(q_2)}
\end{align}
For a given set of parameters, the eigenvalues of the linearized dynamics can be
parameterized by three quantities: lean $q_2$, yaw rate $\dot{q}_1$, and spin
rate $\dot{q}_3$ (though only two can be independent because of the above
restrictions). For this more general equilibrium condition, there are still six
zero eigenvalues, while the two non-zero eigenvalues are
\begin{align}
\lambda_{1,2} = \pm\sqrt{\frac{4}{5} \cos\left(q_{2}\right) - \dot{q}_{1}^{2} -\frac{14}{5} \sin\left(q_{2}\right) \dot{q}_{1} \dot{q}_{3} - \frac{12}{5}\dot{q}_{3}^{2}}
\end{align}
which can be easily shown to reduce to Equation (\ref{eq:upright_evals}) when
$q_2 = \dot{q}_1 = 0$. For a more detailed stability of steadily rolling disks,
see~\cite{OReilly1996,Neimark1972,Kuleshov2001}.

\section{Discussion}
\label{sec:discussion}
Most modern control techniques assume a system can be written as
\begin{align}
\dot{x} = Ax + Br
\end{align}
(traditionally $u$ is used instead of $r$, but Kane's method reserves $u$ for
generalized speeds, so we use $r$ to denote what is traditionally written as $u$
in control-focused literature). \autoref{eq:state_space_constrained} isn't
square, so it doesn't fit into the standard linear system framework. To obtain
a square system we define
\begin{align}
\tilde{A} &=
   \left[
     \begin{array}{cc}
       (\tilde{A}_{qq} + \tilde{A}_{qu} C_1 ) C_0 & \tilde{A}_{qu} C_2 \\
       (\tilde{A}_{uqc} + \tilde{A}_{uuc} C_1 ) C_0 & \tilde{A}_{uuc} C_2\\
       (\tilde{A}_{uqd} + \tilde{A}_{uud} C_1 ) C_0 & \tilde{A}_{uud} C_2
     \end{array}
   \right]\\
\tilde{B} &= 
    \left[
      \begin{array}{c}
        0_{(n+m) \times s} \\
        \tilde{B}_{u}
      \end{array}
    \right]
\end{align}
from (\ref{eq:state_space_constrained}) and
\begin{align}
  \label{eq:A_prime}
    A^\prime &\triangleq \tilde{M}^{-1} \tilde{A} \\
  \label{eq:B_prime}
    B^\prime &\triangleq \tilde{M}^{-1} \tilde{B}
\end{align}
where  $A^\prime \in \mathbb{R}^{(o + n) \times (o - m + n -l)}$, $B^\prime \in
\mathbb{R}^{(o + n) \times s}$.  We can extract the rows corresponding to the
independent states by defining
\begin{align}
  \label{eq:P_prime}
    P^\prime &\triangleq \begin{bmatrix}
        P_{qi} & O_{n \times (o - m)} \\
        O_{o \times (n - l)} & P_{ui}
    \end{bmatrix} \\
  \label{eq:A}
    A &\triangleq P^{\prime T} A^\prime \\
  \label{eq:B}
    B &\triangleq P^{\prime T} B^\prime
\end{align}
where $P^\prime \in \mathbb{R}^{(o + n) \times (o - m + n - l)}$.  Defining
$x_i = \left[\delta q_i,\,\delta u_i\right]^{T}$ yields the square state space
system $\dot{x}_i = A x_i + B r$ to which standard linear systems analyses may
applied. It is worth noting that the rows of $A^\prime$ and $B^\prime$ which
correspond to dependent states can be used in output or measurement equations
of a linear state space model (e.g., measurements from an accelerometer, or
measurements of dependent speeds).

Kane's dynamical equations are typically formulated for one particular choice
of dependent speeds, and computer code is generated for that single choice of
dependent speeds. It is possible, however, to output computer code for the
unconstrained equations of motion (equation (\ref{eq:kanes_eq})), along with
the velocity constraint coefficient matrix (equation (\ref{eq:constraint_B})),
such that the independent choice of speeds and the constrained equations of
motion (equation (\ref{eq:kanes_eq_nonholonomic})) are formed at the time of
numerical evaluation (as opposed to choosing a particular set of dependent
speeds during symbolic derivation). There are several reasons why this can be
desirable: 1) the configuration of the system in question changes significantly
enough during simulation that no single choice of independent speeds will work
for all regions of the configuration space; 2) the choice of parameters greatly
affects which states should be selected to be dependent; and 3) to choose the
dependent states which minimize the effect of numerical round off. This
approach can also be applied to computation of the linearized dynamics. A task
where the ability to switch the choice of dependent states ``on the fly'' is
extremely helpful is in the computation of Lyapunov characteristic exponents
(LCE's). When computing LCE's, time simulation of the nonlinear dynamics
\textit{and} linearization at each point along the trajectory a
required~\cite{Benettin1980a,Benettin1980b,Udwadia2001}; having a computer code
that makes it easy to switch choice of dependent states at the time of
numerical evaluation is of great benefit in this case. The matrices which must
be used to determine the best choice of coordinates and speeds are $\nabla_{q}
f_c P_{qd}$ and $\nabla_{u} f_v P_{ud}$; these matrices appear in equations
(\ref{eq:delta_q}) and (\ref{eq:delta_u}).  If for some choice of dependent
coordinates or dependent speeds either of these matrices are singular or nearly
singular, a different set of dependent coordinates and dependent speeds should
be chosen. These matrices generally depend only upon parameters and coordinates
(not speeds). While some systems may permit a choice of independent state
variables which are valid for all configurations of interest, others may not.
Methods for automatically selecting the ``best'' choice of independent state
variables are discussed in~\cite{Reckdahl1996}; they involve computing the
singular value decomposition $\nabla_q f_c$ and $\nabla_u f_v$ to determine a
set of independent states which will ensure the non-singularity of the
aforementioned matrices.

\section{Conclusions}
A procedure for forming linearized equations of motion for constrained
multi-body systems has been presented. This procedure can be implemented
symbolically or numerically, and handles configuration, velocity, and
acceleration level constraints. The coefficient matrices in equation
(\ref{eq:state_space_constrained}) can generally be computed symbolically and
output as efficient C/C++/Fortran routines which may be compiled into highly
efficient machine code. This permits library routines which are both highly
efficient (no finite differences) and very general (arbitrary system parameters
and linearization point).

The procedure has been implemented symbolically in the
\texttt{sympy.physics.mechanics} sub-module of the open source symbolic
manipulator SymPy~\cite{SymPy}. In addition to the rolling disk example, we
have also applied it to the extended Whipple bicycle model described in
\hyperref[chapter2]{Chapter 2}~\cite{libbicycle}, and obtained results that matched (to at
least 14 digits) the eigenvalues published for a benchmark set of
parameters~\cite{Meijaard2007}. This latter example provides a challenging and
rigorous test of the procedure which strongly indicates both its utility and
its correctness.

